/* @preserve bluelinky / MIT License / https://github.com/Hacksore/bluelinky */
"use strict";var e,t=(e=require("got"))&&"object"==typeof e&&"default"in e?e.default:e,n=require("winston"),r=require("url"),o=require("push-receiver"),i=require("tough-cookie"),s=require("events"),a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function c(e,t){function n(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var u=function(){return(u=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function l(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function h(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}var d,v=process.env.LOG_LEVEL||"info",p=n.format,f=p.colorize,g=p.json,m=p.combine,b=p.timestamp,y=(0,p.printf)((function(e){var t=e.level,n=e.message,r=e.timestamp;return["array","object"].includes(typeof n)&&(n=JSON.stringify(n,null,2)),"["+r+"] "+t+": "+n})),k=m(b({format:"YYYY-MM-DD HH:mm:ss"}),f(),g(),y),w=n.createLogger({format:k,level:v,transports:[new n.transports.Console({})]}),C="https://mybluelink.ca",T={login:C+"/tods/api/lgn",logout:C+"/tods/api/lgout",myAccount:C+"/tods/api/acctinfo",nextService:C+"/tods/api/nxtsvc",preferedDealer:C+"/tods/api/gtprfrdlr",vehicleList:C+"/tods/api/vhcllst",vehicleInfo:C+"/tods/api/sltvhcl",status:C+"/tods/api/lstvhclsts",remoteStatus:C+"/tods/api/rltmvhclsts",lock:C+"/tods/api/drlck",unlock:C+"/tods/api/drulck",start:C+"/tods/api/evc/rfon",stop:C+"/tods/api/evc/rfoff",locate:C+"/tods/api/fndmcr",hornlight:C+"/tods/api/hornlight",verifyAccountToken:C+"/tods/api/vrfyacctkn",verifyPin:C+"/tods/api/vrfypin",verifyToken:C+"/tods/api/vrfytnc"},H="prd.eu-ccapi.hyundai.com:8080",S="https://"+H,A="Basic NmQ0NzdjMzgtM2NhNC00Y2YzLTk1NTctMmExOTI5YTk0NjU0OktVeTQ5WHhQekxwTHVvSzB4aEJDNzdXNlZYaG10UVI5aVFobUlGampvWTRJcHhzVg==",L="199360397125",_={CA:T,EU:{session:S+"/api/v1/user/oauth2/authorize?response_type=code&state=test&client_id=6d477c38-3ca4-4cf3-9557-2a1929a94654&redirect_uri="+S+"/api/v1/user/oauth2/redirect",login:S+"/api/v1/user/signin",language:S+"/api/v1/user/language",redirectUri:S+"/api/v1/user/oauth2/redirect",token:S+"/api/v1/user/oauth2/token"}};!function(e){e.US="US",e.CA="CA",e.EU="EU"}(d||(d={}));var O={refresh:!1,parsed:!1},x="api.telematics.hyundaiusa.com",P="https://"+x,I="815c046afaa4471aa578827ad546cc76",E=function(){function e(e,t){this.vehicleConfig=e,this.controller=t,this._status=null,this._location=null,this._odometer=null,this.userConfig={username:void 0,password:void 0,region:d.EU,autoLogin:!0,pin:void 0,vin:void 0,vehicleId:void 0},this.userConfig=t.userConfig}return e.prototype.vin=function(){return this.vehicleConfig.vin},e.prototype.name=function(){return this.vehicleConfig.name},e.prototype.nickname=function(){return this.vehicleConfig.nickname},e.prototype.id=function(){return this.vehicleConfig.id},e.prototype.brandIndicator=function(){return this.vehicleConfig.brandIndicator},e}(),D=function(e){function n(t,n){var r=e.call(this,t,n)||this;return r.vehicleConfig=t,r.controller=n,r.region=d.US,w.debug("US Vehicle "+r.vehicleConfig.id+" created"),r}return c(n,e),n.prototype.getDefaultHeaders=function(){return{access_token:this.controller.session.accessToken,client_id:I,Host:x,"User-Agent":"okhttp/3.12.0",registrationId:this.vehicleConfig.regId,gen:this.vehicleConfig.generation,username:this.userConfig.username,vin:this.vehicleConfig.vin,"APPCLOUD-VIN":this.vehicleConfig.vin,Language:"0",to:"ISS",encryptFlag:"false",from:"SPA",brandIndicator:this.vehicleConfig.brandIndicator,bluelinkservicepin:this.userConfig.pin,offset:"-5"}},n.prototype.odometer=function(){return l(this,void 0,void 0,(function(){var e,t,n,r=this;return h(this,(function(o){switch(o.label){case 0:return[4,this._request("/ac/v2/enrollment/details/"+this.userConfig.username,{method:"GET",headers:u({},this.getDefaultHeaders())})];case 1:if(200!==(e=o.sent()).statusCode)throw"Failed to get odometer reading!";return t=JSON.parse(e.body),n=t.enrolledVehicleDetails.find((function(e){return e.vehicleDetails.vin===r.vin()})),this._odometer={value:n.vehicleDetails.odometer,unit:0},[2,this._odometer]}}))}))},n.prototype.location=function(){return l(this,void 0,void 0,(function(){var e,t;return h(this,(function(n){switch(n.label){case 0:return[4,this._request("/ac/v2/rcs/rfc/findMyCar",{method:"GET",headers:u({},this.getDefaultHeaders())})];case 1:if(200!==(e=n.sent()).statusCode)throw"Failed to get location!";return[2,{latitude:(t=JSON.parse(e.body)).coord.lat,longitude:t.coord.lon,altitude:t.coord.alt,speed:{unit:t.speed.unit,value:t.speed.value},heading:t.head}]}}))}))},n.prototype.start=function(e){return l(this,void 0,void 0,(function(){var t,n;return h(this,(function(r){switch(r.label){case 0:return t=u({airCtrl:!1,igniOnDuration:10,airTempvalue:70,defrost:!1,heating1:!1},e),n={Ims:0,airCtrl:+t.airCtrl,airTemp:{unit:1,value:""+t.airTempvalue},defrost:t.defrost,heating1:+t.heating1,igniOnDuration:t.igniOnDuration,seatHeaterVentInfo:null,username:this.userConfig.username,vin:this.vehicleConfig.vin},[4,this._request("/ac/v2/rcs/rsc/start",{method:"POST",headers:u(u({},this.getDefaultHeaders()),{offset:"-4"}),body:n,json:!0})];case 1:return 200===r.sent().statusCode?[2,"Vehicle started!"]:[2,"Failed to start vehicle"]}}))}))},n.prototype.stop=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return[4,this._request("/ac/v2/rcs/rsc/stop",{method:"POST",headers:u(u({},this.getDefaultHeaders()),{offset:"-4"})})];case 1:if(200===e.sent().statusCode)return[2,"Vehicle stopped"];throw"Failed to stop vehicle!"}}))}))},n.prototype.status=function(e){var t,n,r,o,i,s,a,c,d,v,p,f,g,m,b;return l(this,void 0,void 0,(function(){var l,y,k,w;return h(this,(function(h){switch(h.label){case 0:return l=u(u({},O),e),[4,this._request("/ac/v2/rcs/rvs/vehicleStatus",{method:"GET",headers:u({REFRESH:l.refresh.toString()},this.getDefaultHeaders())})];case 1:return y=h.sent(),k=JSON.parse(y.body).vehicleStatus,w={chassis:{hoodOpen:null==k?void 0:k.hoodOpen,trunkOpen:null==k?void 0:k.trunkOpen,locked:null==k?void 0:k.doorLock,openDoors:{frontRight:!!(null===(t=null==k?void 0:k.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(n=null==k?void 0:k.doorOpen)||void 0===n?void 0:n.frontLeft),backLeft:!!(null===(r=null==k?void 0:k.doorOpen)||void 0===r?void 0:r.backLeft),backRight:!!(null===(o=null==k?void 0:k.doorOpen)||void 0===o?void 0:o.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(i=null==k?void 0:k.tirePressureLamp)||void 0===i?void 0:i.tirePressureWarningLampRearLeft),frontLeft:!!(null===(s=null==k?void 0:k.tirePressureLamp)||void 0===s?void 0:s.tirePressureWarningLampFrontLeft),frontRight:!!(null===(a=null==k?void 0:k.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampFrontRight),rearRight:!!(null===(c=null==k?void 0:k.tirePressureLamp)||void 0===c?void 0:c.tirePressureWarningLampRearRight),all:!!(null===(d=null==k?void 0:k.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampAll)}},climate:{active:null==k?void 0:k.airCtrlOn,steeringwheelHeat:!!(null==k?void 0:k.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==k?void 0:k.sideBackWindowHeat),defrost:null==k?void 0:k.defrost,temperatureSetpoint:null===(v=null==k?void 0:k.airTemp)||void 0===v?void 0:v.value,temperatureUnit:null===(p=null==k?void 0:k.airTemp)||void 0===p?void 0:p.unit},engine:{ignition:null==k?void 0:k.engine,adaptiveCruiseControl:null==k?void 0:k.acc,range:null===(f=null==k?void 0:k.dte)||void 0===f?void 0:f.value,charging:null===(g=null==k?void 0:k.evStatus)||void 0===g?void 0:g.batteryCharge,batteryCharge12v:null===(m=null==k?void 0:k.battery)||void 0===m?void 0:m.batSoc,batteryChargeHV:null===(b=null==k?void 0:k.evStatus)||void 0===b?void 0:b.batteryStatus}},this._status=l.parsed?w:k,[2,this._status]}}))}))},n.prototype.unlock=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:return(e=new r.URLSearchParams).append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin),[4,this._request("/ac/v2/rcs/rdo/on",{method:"POST",headers:u({},this.getDefaultHeaders()),body:e.toString()})];case 1:return 200===t.sent().statusCode?[2,"Unlock successful"]:[2,"Something went wrong!"]}}))}))},n.prototype.lock=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:return(e=new r.URLSearchParams).append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin),[4,this._request("/ac/v2/rcs/rdo/off",{method:"POST",headers:u({},this.getDefaultHeaders()),body:e.toString()})];case 1:return 200===t.sent().statusCode?[2,"Lock successful"]:[2,"Something went wrong!"]}}))}))},n.prototype.startCharge=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return[4,this._request("/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/charge",{method:"POST"})];case 1:if(200===e.sent().statusCode)return w.debug("Send start charge command to Vehicle "+this.vehicleConfig.id),[2,"Start charge successful"];throw"Something went wrong!"}}))}))},n.prototype.stopCharge=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return[4,t("/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/charge",{method:"POST"})];case 1:if(200===e.sent().statusCode)return w.debug("Send stop charge command to vehicle "+this.vehicleConfig.id),[2,"Stop charge successful"];throw"Something went wrong!"}}))}))},n.prototype._request=function(e,n){return l(this,void 0,void 0,(function(){var r,o;return h(this,(function(i){switch(i.label){case 0:return r=Math.floor(+new Date/1e3),-(r-this.controller.session.tokenExpiresAt)<=60?(w.debug("Token is expiring soon, let's get a new one"),[4,this.controller.refreshAccessToken()]):[3,2];case 1:return i.sent(),[3,3];case 2:w.debug("Token is all good, moving on!"),i.label=3;case 3:return[4,t(P+"/"+e,u({throwHttpErrors:!1},n))];case 4:return o=i.sent(),w.debug(o.body),[2,o]}}))}))},n}(E),U=function(e){this.session={accessToken:"",refreshToken:"",controlToken:"",deviceId:"",tokenExpiresAt:0},this.userConfig=e},q=function(e){function n(t){var n=e.call(this,t)||this;return n.vehicles=[],w.debug("US Controller created"),n}return c(n,e),n.prototype.refreshAccessToken=function(){return l(this,void 0,void 0,(function(){var e,n;return h(this,(function(r){switch(r.label){case 0:return e=Math.floor(+new Date/1e3-this.session.tokenExpiresAt)<=10,this.session.refreshToken&&e?(w.debug("refreshing token"),[4,t(P+"/v2/ac/oauth/token/refresh",{method:"POST",body:{refresh_token:this.session.refreshToken},headers:{client_secret:"GXZveJJAVTehh/OtakM3EQ==",client_id:I},json:!0})]):[3,2];case 1:return n=r.sent(),this.session.accessToken=n.body.access_token,this.session.refreshToken=n.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(n.body.expires_in)),[2,"Token refreshed"];case 2:return[2,"Token not expired, no need to refresh"]}}))}))},n.prototype.login=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(n){switch(n.label){case 0:return w.debug("Logging in to API"),[4,t(P+"/v2/ac/oauth/token",{method:"POST",body:{username:this.userConfig.username,password:this.userConfig.password},headers:{client_secret:"GXZveJJAVTehh/OtakM3EQ==",client_id:I},json:!0})];case 1:return 200!==(e=n.sent()).statusCode?[2,"login bad"]:(this.session.accessToken=e.body.access_token,this.session.refreshToken=e.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(e.body.expires_in)),[2,"login good"])}}))}))},n.prototype.logout=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){return[2,"OK"]}))}))},n.prototype.getVehicles=function(){return l(this,void 0,void 0,(function(){var e,n,r=this;return h(this,(function(o){switch(o.label){case 0:return[4,t(P+"/ac/v2/enrollment/details/"+this.userConfig.username,{method:"GET",headers:{access_token:this.session.accessToken,client_id:I,Host:x,"User-Agent":"okhttp/3.12.0",payloadGenerated:"20200226171938",includeNonConnectedVehicles:"Y"}})];case 1:return e=o.sent(),void 0===(n=JSON.parse(e.body)).enrolledVehicleDetails?(this.vehicles=[],[2,this.vehicles]):(n.enrolledVehicleDetails.forEach((function(e){var t=e.vehicleDetails,n={nickname:t.nickName,name:t.nickName,vin:t.vin,regDate:t.enrollmentDate,brandIndicator:t.brandIndicator,regId:t.regid,generation:t.modelYear>2016?"2":"1"};r.vehicles.push(new D(n,r))})),[2,this.vehicles])}}))}))},n}(U),R=function(e){switch(e){case 14:return"00H";case 14.5:return"01H";case 15:return"02H";case 15.5:return"03H";case 16:return"04H";case 16.5:return"05H";case 17:return"06H";case 17.5:return"07H";case 18:return"08H";case 18.5:return"09H";case 19:return"0AH";case 19.5:return"0BH";case 20:return"0CH";case 20.5:return"0DH";case 21:return"0EH";case 21.5:return"0FH";case 22:return"10H";case 22.5:return"11H";case 23:return"12H";case 23.5:return"13H";case 24:return"14H";case 24.5:return"15H";case 25:return"16H";case 25.5:return"17H";case 26:return"18H";case 26.5:return"19H";case 27:return"1AH";case 27.5:return"1BH";case 28:return"1CH";case 28.5:return"1DH";case 29:return"1EH";case 29.5:return"1FH";case 30:return"20H";default:throw new Error("temperature out of bounds! min: 14.0* max: 30*, max step: 0.5")}},j=function(e){switch(e){case"00H":return 14;case"01H":return 14.5;case"02H":return 15;case"03H":return 15.5;case"04H":return 16;case"05H":return 16.5;case"06H":return 17;case"07H":return 17.5;case"08H":return 18;case"09H":return 18.5;case"0AH":return 19;case"0BH":return 19.5;case"0CH":return 20;case"0DH":return 20.5;case"0EH":return 21;case"0FH":return 21.5;case"10H":case"11H":return 22;case"12H":return 23;case"13H":return 23.5;case"14H":return 24;case"15H":return 24.5;case"16H":return 25;case"17H":return 25.5;case"18H":return 26;case"19H":return 26.5;case"1AH":return 27;case"1BH":return 27.5;case"1CH":return 28;case"1DH":return 28.5;case"1EH":return 29;case"1FH":return 29.5;case"20H":return 30;default:throw new Error("temperature out of bounds! min: 14.0* max: 30*, max step: 0.5")}},V=function(e){function n(t,n){var r=e.call(this,t,n)||this;return r.vehicleConfig=t,r.controller=n,r.region=d.EU,w.debug("EU Vehicle "+r.vehicleConfig.id+" created"),r}return c(n,e),n.prototype.checkControlToken=function(){var e;return l(this,void 0,void 0,(function(){return h(this,(function(t){switch(t.label){case 0:return[4,this.controller.refreshAccessToken()];case 1:return t.sent(),void 0===(null===(e=this.controller.session)||void 0===e?void 0:e.controlTokenExpiresAt)?[3,3]:!this.controller.session.controlToken||Date.now()/1e3>this.controller.session.controlTokenExpiresAt?[4,this.controller.enterPin()]:[3,3];case 2:t.sent(),t.label=3;case 3:return[2]}}))}))},n.prototype.start=function(e){return l(this,void 0,void 0,(function(){var n;return h(this,(function(r){switch(r.label){case 0:return[4,this.checkControlToken()];case 1:return r.sent(),[4,t(S+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/temperature",{method:"POST",body:{action:"start",hvacType:0,options:{defrost:e.defrost,heating1:e.windscreenHeating?1:0},tempCode:R(e.temperature),unit:e.unit},headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},json:!0})];case 2:return n=r.sent(),w.info("Climate started for vehicle "+this.vehicleConfig.id),[2,n.body]}}))}))},n.prototype.stop=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(n){switch(n.label){case 0:return[4,this.checkControlToken()];case 1:return n.sent(),[4,t(S+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/temperature",{method:"POST",body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"},headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},json:!0})];case 2:return e=n.sent(),w.info("Climate stopped for vehicle "+this.vehicleConfig.id),[2,e.body]}}))}))},n.prototype.lock=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return[4,this.checkControlToken()];case 1:return e.sent(),[4,t(S+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/door",{method:"POST",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},body:{action:"close",deviceId:this.controller.session.deviceId},json:!0})];case 2:return 200===e.sent().statusCode?(w.debug("Vehicle "+this.vehicleConfig.id+" locked"),[2,"Lock successful"]):[2,"Something went wrong!"]}}))}))},n.prototype.unlock=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return[4,this.checkControlToken()];case 1:return e.sent(),[4,t(S+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/door",{method:"POST",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},body:{action:"open",deviceId:this.controller.session.deviceId},json:!0})];case 2:return 200===e.sent().statusCode?(w.debug("Vehicle "+this.vehicleConfig.id+" unlocked"),[2,"Unlock successful"]):[2,"Something went wrong!"]}}))}))},n.prototype.status=function(e){var n,r,o,i,s,a,c,d,v,p,f,g,m,b,y,k,w;return l(this,void 0,void 0,(function(){var l,C,T,H,A;return h(this,(function(h){switch(h.label){case 0:return l=u(u({},O),e),[4,this.checkControlToken()];case 1:return h.sent(),C=l.refresh?"":"/latest",[4,t(S+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/status"+C,{method:"GET",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},json:!0})];case 2:return T=h.sent(),H=l.refresh?T.body.resMsg:T.body.resMsg.vehicleStatusInfo.vehicleStatus,A={chassis:{hoodOpen:null==H?void 0:H.hoodOpen,trunkOpen:null==H?void 0:H.trunkOpen,locked:H.doorLock,openDoors:{frontRight:!!(null===(n=null==H?void 0:H.doorOpen)||void 0===n?void 0:n.frontRight),frontLeft:!!(null===(r=null==H?void 0:H.doorOpen)||void 0===r?void 0:r.frontLeft),backLeft:!!(null===(o=null==H?void 0:H.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(i=null==H?void 0:H.doorOpen)||void 0===i?void 0:i.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(s=null==H?void 0:H.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampRL),frontLeft:!!(null===(a=null==H?void 0:H.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFL),frontRight:!!(null===(c=null==H?void 0:H.tirePressureLamp)||void 0===c?void 0:c.tirePressureLampFR),rearRight:!!(null===(d=null==H?void 0:H.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(v=null==H?void 0:H.tirePressureLamp)||void 0===v?void 0:v.tirePressureWarningLampAll)}},climate:{active:null==H?void 0:H.airCtrlOn,steeringwheelHeat:!!(null==H?void 0:H.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==H?void 0:H.sideBackWindowHeat),defrost:null==H?void 0:H.defrost,temperatureSetpoint:j(null===(p=null==H?void 0:H.airTemp)||void 0===p?void 0:p.value),temperatureUnit:null===(f=null==H?void 0:H.airTemp)||void 0===f?void 0:f.unit},engine:{ignition:H.engine,adaptiveCruiseControl:null==H?void 0:H.acc,range:null===(b=null===(m=null===(g=null==H?void 0:H.evStatus)||void 0===g?void 0:g.drvDistance[0].rangeByFuel)||void 0===m?void 0:m.totalAvailableRange)||void 0===b?void 0:b.value,charging:null===(y=null==H?void 0:H.evStatus)||void 0===y?void 0:y.batteryCharge,batteryCharge12v:null===(k=null==H?void 0:H.battery)||void 0===k?void 0:k.batSoc,batteryChargeHV:null===(w=null==H?void 0:H.evStatus)||void 0===w?void 0:w.batteryStatus}},this._status=l.parsed?A:H,[2,this._status]}}))}))},n.prototype.odometer=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(n){switch(n.label){case 0:return[4,this.checkControlToken()];case 1:return n.sent(),[4,t(S+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/status/latest",{method:"GET",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},json:!0})];case 2:return e=n.sent(),this._odometer=e.body.resMsg.vehicleStatusInfo.odometer,[2,this._odometer]}}))}))},n.prototype.location=function(){return l(this,void 0,void 0,(function(){var e,n;return h(this,(function(r){switch(r.label){case 0:return[4,this.checkControlToken()];case 1:return r.sent(),[4,t(S+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/location",{method:"GET",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},json:!0})];case 2:return e=r.sent(),n=e.body.resMsg.gpsDetail,this._location={latitude:n.coord.lat,longitude:n.coord.lon,altitude:n.coord.alt,speed:{unit:n.speed.unit,value:n.speed.value},heading:n.head},[2,this._location]}}))}))},n.prototype.startCharge=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return[4,this.checkControlToken()];case 1:return e.sent(),[4,t(S+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/charge",{method:"POST",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},body:{action:"start",deviceId:this.controller.session.deviceId},json:!0})];case 2:if(200===e.sent().statusCode)return w.debug("Send start charge command to Vehicle "+this.vehicleConfig.id),[2,"Start charge successful"];throw"Something went wrong!"}}))}))},n.prototype.stopCharge=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:return[4,this.checkControlToken()];case 1:return e.sent(),[4,t(S+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/charge",{method:"POST",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},body:{action:"stop",deviceId:this.controller.session.deviceId},json:!0})];case 2:if(200===e.sent().statusCode)return w.debug("Send stop charge command to Vehicle "+this.vehicleConfig.id),[2,"Stop charge successful"];throw"Something went wrong!"}}))}))},n}(E),M=function(e){function n(t){var n=e.call(this,t)||this;return n.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:n.uuidv4(),tokenExpiresAt:0,controlTokenExpiresAt:0},n.vehicles=[],w.debug("EU Controller created"),n.session.deviceId=n.uuidv4(),n}return c(n,e),n.prototype.uuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))},n.prototype.refreshAccessToken=function(){return l(this,void 0,void 0,(function(){var e,n,o,i;return h(this,(function(s){switch(s.label){case 0:return e=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10,this.session.refreshToken?e?((n=new r.URLSearchParams).append("grant_type","refresh_token"),n.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),n.append("refresh_token",this.session.refreshToken),[4,t(_.EU.token,{method:"POST",headers:{Authorization:A,"Content-Type":"application/x-www-form-urlencoded",Host:H,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:n.toString(),throwHttpErrors:!1})]):[2,"Token not expired, no need to refresh"]:[2,"Need refresh token to refresh access token. Use login()"];case 1:return 200!==(o=s.sent()).statusCode?[2,"Refresh token failed: "+o.body]:(i=JSON.parse(o.body),this.session.accessToken="Bearer "+i.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+i.expires_in),[2,"Token refreshed"])}}))}))},n.prototype.enterPin=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(n){switch(n.label){case 0:if(""===this.session.accessToken)throw"Token not set";return[4,t(S+"/api/v1/user/pin",{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0})];case 1:return e=n.sent(),this.session.controlToken="Bearer "+e.body.controlToken,this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+e.body.expiresTime),[2,"PIN entered OK, The pin is valid for 10 minutes"]}}))}))},n.prototype.login=function(){return l(this,void 0,void 0,(function(){var e,n,s,a,c,u,l,d,v;return h(this,(function(h){switch(h.label){case 0:return h.trys.push([0,7,,8]),e=new i.CookieJar,[4,t(_.EU.session,{cookieJar:e})];case 1:return h.sent(),[4,t(_.EU.language,{method:"POST",body:'{"lang":"en"}',cookieJar:e})];case 2:return h.sent(),[4,t(_.EU.login,{method:"POST",json:!0,body:{email:this.userConfig.username,password:this.userConfig.password},cookieJar:e})];case 3:if(n=h.sent(),w.debug(n.body),s=void 0,n){if(null===(a=/code=([^&]*)/g.exec(n.body.redirectUrl)))throw new Error("@EuropeControllerLogin: AuthCode was not found");s=a[1]}return[4,o.register(L)];case 4:return c=h.sent(),[4,t(S+"/api/v1/spa/notifications/register",{method:"POST",headers:{"ccsp-service-id":"6d477c38-3ca4-4cf3-9557-2a1929a94654","Content-Type":"application/json;charset=UTF-8",Host:H,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:{pushRegId:c.gcm.token,pushType:"GCM",uuid:this.session.deviceId},json:!0})];case 5:return(u=h.sent())&&(this.session.deviceId=u.body.resMsg.deviceId),(l=new r.URLSearchParams).append("grant_type","authorization_code"),l.append("redirect_uri",_.EU.redirectUri),l.append("code",s),[4,t(_.EU.token,{method:"POST",headers:{Authorization:A,"Content-Type":"application/x-www-form-urlencoded",Host:H,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code"},body:l.toString(),cookieJar:e})];case 6:if(200!==(d=h.sent()).statusCode)throw"Get token failed: "+d.body;return d&&(v=JSON.parse(d.body),this.session.accessToken="Bearer "+v.access_token,this.session.refreshToken=v.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+v.expires_in)),[2,"Login success"];case 7:throw h.sent().message;case 8:return[2]}}))}))},n.prototype.logout=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){return[2,"OK"]}))}))},n.prototype.getVehicles=function(){return l(this,void 0,void 0,(function(){var e,n=this;return h(this,(function(r){switch(r.label){case 0:if(void 0===this.session.accessToken)throw"Token not set";return[4,t(S+"/api/v1/spa/vehicles",{method:"GET",headers:{Authorization:this.session.accessToken,"ccsp-device-id":this.session.deviceId},json:!0})];case 1:return e=r.sent(),this.vehicles=[],[4,this.asyncForEach(e.body.resMsg.vehicles,(function(e){return l(n,void 0,void 0,(function(){var n,r,o;return h(this,(function(i){switch(i.label){case 0:return[4,t(S+"/api/v1/spa/vehicles/"+e.vehicleId+"/profile",{method:"GET",headers:{Authorization:this.session.accessToken,"ccsp-device-id":this.session.deviceId},json:!0})];case 1:return n=i.sent(),r=n.body.resMsg,o={nickname:e.nickname,name:e.vehicleName,regDate:e.regDate,brandIndicator:"H",id:e.vehicleId,vin:r.vinInfo[0].basic.vin,generation:r.vinInfo[0].basic.modelYear},this.vehicles.push(new V(o,this)),w.debug("Added vehicle "+o.id),[2]}}))}))}))];case 2:return r.sent(),[2,this.vehicles]}}))}))},n.prototype.asyncForEach=function(e,t){return l(this,void 0,void 0,(function(){var n;return h(this,(function(r){switch(r.label){case 0:n=0,r.label=1;case 1:return n<e.length?[4,t(e[n],n,e)]:[3,4];case 2:r.sent(),r.label=3;case 3:return n++,[3,1];case 4:return[2]}}))}))},n}(U),N=function(e){function n(t,n){var r=e.call(this,t,n)||this;return r.vehicleConfig=t,r.controller=n,r._nextService=null,r._info=null,r._features=null,r._featuresModel=null,r.region=d.CA,r.timeOffset=-(new Date).getTimezoneOffset()/60,w.debug("CA Vehicle "+r.vehicleConfig.id+" created"),r}return c(n,e),n.prototype.vehicleInfo=function(){return l(this,void 0,void 0,(function(){var e,t;return h(this,(function(n){switch(n.label){case 0:w.debug("Begin vehicleInfo request"),n.label=1;case 1:return n.trys.push([1,3,,4]),[4,this.request(T.vehicleInfo,{})];case 2:return e=n.sent(),t=e.result,this._info=t.vehicleInfo,this._status=t.status,this._features=t.features,this._featuresModel=t.featuresModel,[2,t];case 3:throw n.sent().message;case 4:return[2]}}))}))},n.prototype.status=function(e){var t,n,r,o,i,s,a,c,d,v,p,f,g,m,b;return l(this,void 0,void 0,(function(){var l,y,k,C,H;return h(this,(function(h){switch(h.label){case 0:l=u(u({},O),e),w.debug("Begin status request, polling car: "+e.refresh),h.label=1;case 1:return h.trys.push([1,3,,4]),y=l.refresh?T.remoteStatus:T.status,[4,this.request(y,{})];case 2:return k=h.sent(),C=k.result,H={chassis:{hoodOpen:null==C?void 0:C.hoodOpen,trunkOpen:null==C?void 0:C.trunkOpen,locked:null==C?void 0:C.doorLock,openDoors:{frontRight:!!(null===(t=null==C?void 0:C.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(n=null==C?void 0:C.doorOpen)||void 0===n?void 0:n.frontLeft),backLeft:!!(null===(r=null==C?void 0:C.doorOpen)||void 0===r?void 0:r.backLeft),backRight:!!(null===(o=null==C?void 0:C.doorOpen)||void 0===o?void 0:o.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(i=null==C?void 0:C.tirePressureLamp)||void 0===i?void 0:i.tirePressureWarningLampRearLeft),frontLeft:!!(null===(s=null==C?void 0:C.tirePressureLamp)||void 0===s?void 0:s.tirePressureWarningLampFrontLeft),frontRight:!!(null===(a=null==C?void 0:C.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampFrontRight),rearRight:!!(null===(c=null==C?void 0:C.tirePressureLamp)||void 0===c?void 0:c.tirePressureWarningLampRearRight),all:!!(null===(d=null==C?void 0:C.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampAll)}},climate:{active:null==C?void 0:C.airCtrlOn,steeringwheelHeat:!!(null==C?void 0:C.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==C?void 0:C.sideBackWindowHeat),defrost:null==C?void 0:C.defrost,temperatureSetpoint:null===(v=null==C?void 0:C.airTemp)||void 0===v?void 0:v.value,temperatureUnit:null===(p=null==C?void 0:C.airTemp)||void 0===p?void 0:p.unit},engine:{ignition:null==C?void 0:C.engine,adaptiveCruiseControl:null==C?void 0:C.acc,range:null===(f=null==C?void 0:C.dte)||void 0===f?void 0:f.value,charging:null===(g=null==C?void 0:C.evStatus)||void 0===g?void 0:g.batteryCharge,batteryCharge12v:null===(m=null==C?void 0:C.battery)||void 0===m?void 0:m.batSoc,batteryChargeHV:null===(b=null==C?void 0:C.evStatus)||void 0===b?void 0:b.batteryStatus}},this._status=l.parsed?H:C,[2,this._status];case 3:throw h.sent().message;case 4:return[2]}}))}))},n.prototype.nextService=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:w.debug("Begin nextService request"),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.request(T.nextService,{})];case 2:return e=t.sent(),this._nextService=e.result,[2,this._nextService];case 3:throw t.sent().message;case 4:return[2]}}))}))},n.prototype.lock=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:w.debug("Begin lock request"),t.label=1;case 1:return t.trys.push([1,4,,5]),[4,this.getPreAuth()];case 2:return e=t.sent(),[4,this.request(T.lock,{},{pAuth:e})];case 3:return t.sent(),[2,"Lock successful"];case 4:throw t.sent().message;case 5:return[2]}}))}))},n.prototype.unlock=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:w.debug("Begin unlock request"),t.label=1;case 1:return t.trys.push([1,4,,5]),[4,this.getPreAuth()];case 2:return e=t.sent(),[4,this.request(T.unlock,{},{pAuth:e})];case 3:return t.sent(),[2,"Unlock successful"];case 4:throw t.sent().message;case 5:return[2]}}))}))},n.prototype.start=function(e){var t,n,r,o,i;return l(this,void 0,void 0,(function(){var s,a,c,u;return h(this,(function(l){switch(l.label){case 0:w.debug("Begin startClimate request"),l.label=1;case 1:if(l.trys.push([1,4,,5]),s={hvacInfo:{airCtrl:null!==(t=e.airCtrl)&&void 0!==t&&t||null!==(n=e.defrost)&&void 0!==n&&n?1:0,defrost:null!==(r=e.defrost)&&void 0!==r&&r,heating1:e.heating1?1:0}},null!=(a=e.airTempvalue)){if(a>27||a<17)return[2,"air temperature should be between 17 and 27 degrees"];2==(c=(6+2*(a-17)).toString(16).toUpperCase()+"H").length&&(c="0"+c),s.hvacInfo.airTemp={value:c,unit:0,hvacTempType:1}}else if(null!==(o=e.airCtrl)&&void 0!==o&&o||null!==(i=e.defrost)&&void 0!==i&&i)throw"air temperature should be specified";return[4,this.getPreAuth()];case 2:return u=l.sent(),[4,this.request(T.start,s,{pAuth:u})];case 3:return[2,l.sent()];case 4:throw l.sent().message;case 5:return[2]}}))}))},n.prototype.stop=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:w.debug("Begin stop request"),t.label=1;case 1:return t.trys.push([1,4,,5]),[4,this.getPreAuth()];case 2:return e=t.sent(),[4,this.request(T.stop,{pAuth:e})];case 3:return[2,t.sent()];case 4:throw"error: "+t.sent();case 5:return[2]}}))}))},n.prototype.lights=function(e){return void 0===e&&(e=!1),l(this,void 0,void 0,(function(){var t;return h(this,(function(n){switch(n.label){case 0:w.debug("Begin lights request with horn "+e),n.label=1;case 1:return n.trys.push([1,4,,5]),[4,this.getPreAuth()];case 2:return t=n.sent(),[4,this.request(T.hornlight,{horn:e},{pAuth:t})];case 3:return[2,n.sent()];case 4:throw"error: "+n.sent();case 5:return[2]}}))}))},n.prototype.odometer=function(){throw new Error("Method not implemented.")},n.prototype.location=function(){return l(this,void 0,void 0,(function(){var e,t;return h(this,(function(n){switch(n.label){case 0:w.debug("Begin locate request"),n.label=1;case 1:return n.trys.push([1,4,,5]),[4,this.getPreAuth()];case 2:return e=n.sent(),[4,this.request(T.locate,{},{pAuth:e})];case 3:return t=n.sent(),this._location=t.result,[2,this._location];case 4:throw"error: "+n.sent();case 5:return[2]}}))}))},n.prototype.getPreAuth=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){switch(e.label){case 0:w.info("Begin pre-authentication"),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.request(T.verifyPin,{})];case 2:return[2,e.sent().result.pAuth];case 3:throw"error: "+e.sent();case 4:return[2]}}))}))},n.prototype.request=function(e,n,r){return void 0===r&&(r={}),l(this,void 0,void 0,(function(){var o;return h(this,(function(i){switch(i.label){case 0:w.debug("["+e+"] "+JSON.stringify(r)+" "+JSON.stringify(n)),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,t(e,{method:"POST",json:!0,headers:u({from:"SPA",language:1,offset:this.timeOffset,accessToken:this.controller.session.accessToken,vehicleId:this.vehicleConfig.id},r),body:u({pin:this.userConfig.pin},n)})];case 2:return 0!=(o=i.sent()).body.responseHeader.responseCode?[2,o.body.responseHeader.responseDesc]:[2,o.body];case 3:throw"error: "+i.sent();case 4:return[2]}}))}))},n}(E),z=function(e){function n(t){var n=e.call(this,t)||this;return n._preferredDealer=null,n._accountInfo=null,n.vehicles=[],n.timeOffset=-(new Date).getTimezoneOffset()/60,w.debug("CA Controller created"),n}return c(n,e),n.prototype.refreshAccessToken=function(){return l(this,void 0,void 0,(function(){var e,t;return h(this,(function(n){switch(n.label){case 0:return e=Math.floor(+new Date/1e3-this.session.tokenExpiresAt)<=10,this.session.refreshToken&&e?[4,this.request(T.verifyToken,{},{})]:[3,2];case 1:return t=n.sent(),this.session.accessToken=t.body.access_token,this.session.refreshToken=t.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+t.body.expires_in),[2,"Token refreshed"];case 2:return[2,"Token not expired, no need to refresh"]}}))}))},n.prototype.login=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:w.info("Begin login request"),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.request(T.login,{loginId:this.userConfig.username,password:this.userConfig.password})];case 2:return e=t.sent(),this.session.accessToken=e.result.accessToken,this.session.refreshToken=e.result.refreshToken,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+e.result.expireIn),[2,"login good"];case 3:return[2,"error: "+t.sent()];case 4:return[2]}}))}))},n.prototype.logout=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){return[2,"OK"]}))}))},n.prototype.getVehicles=function(){return l(this,void 0,void 0,(function(){var e,t,n,r=this;return h(this,(function(o){switch(o.label){case 0:w.info("Begin getVehicleList request"),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.request(T.vehicleList,{})];case 2:return e=o.sent(),void 0===(t=e.result).vehicles?(this.vehicles=[],[2,this.vehicles]):(t.vehicles.forEach((function(e){var t={nickname:e.nickName,name:e.nickName,vin:e.vin,regDate:e.enrollmentDate,brandIndicator:e.brandIndicator,regId:e.regid,id:e.vehicleId,generation:e.genType};r.vehicles.push(new N(t,r))})),[2,this.vehicles]);case 3:return n=o.sent(),w.debug(n),[2,this.vehicles];case 4:return[2]}}))}))},n.prototype.myAccount=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:w.info("Begin myAccount request"),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.request(T.myAccount,{})];case 2:return e=t.sent(),this._accountInfo=e.result,[2,this._accountInfo];case 3:throw t.sent().message;case 4:return[2]}}))}))},n.prototype.preferedDealer=function(){return l(this,void 0,void 0,(function(){var e;return h(this,(function(t){switch(t.label){case 0:w.info("Begin preferedDealer request"),t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.request(T.preferedDealer,{})];case 2:return e=t.sent(),this._preferredDealer=e.result,[2,this._preferredDealer];case 3:throw t.sent().message;case 4:return[2]}}))}))},n.prototype.request=function(e,n,r){return void 0===r&&(r={}),l(this,void 0,void 0,(function(){var o;return h(this,(function(i){switch(i.label){case 0:w.debug("["+e+"] "+JSON.stringify(r)+" "+JSON.stringify(n)),i.label=1;case 1:return i.trys.push([1,3,,4]),[4,t(e,{method:"POST",json:!0,headers:u({from:"SPA",language:1,offset:this.timeOffset,accessToken:this.session.accessToken},r),body:u({},n)})];case 2:if(0!=(o=i.sent()).body.responseHeader.responseCode)throw o.body.responseHeader.responseDesc;return[2,o.body];case 3:throw i.sent().message;case 4:return[2]}}))}))},n}(U),B=function(e){function t(t){var n=e.call(this)||this;switch(n.vehicles=[],n.config={username:"",password:"",region:d.US,autoLogin:!0,pin:"1234",vin:"",vehicleId:void 0},t.region){case d.EU:n.controller=new M(t);break;case d.US:n.controller=new q(t);break;case d.CA:n.controller=new z(t);break;default:throw new Error("Your region is not supported yet.")}return n.config=u(u({},n.config),t),void 0===t.autoLogin&&(n.config.autoLogin=!0),n.onInit(),n}return c(t,e),t.prototype.onInit=function(){this.config.autoLogin&&(w.debug("Bluelinky is logging in automatically, to disable use autoLogin: false"),this.login())},t.prototype.login=function(){return l(this,void 0,void 0,(function(){var e,t,n;return h(this,(function(r){switch(r.label){case 0:w.debug("loggin into to API"),r.label=1;case 1:return r.trys.push([1,4,,5]),[4,this.controller.login()];case 2:return e=r.sent(),t=this,[4,this.controller.getVehicles()];case 3:return t.vehicles=r.sent(),w.debug("Found "+this.vehicles.length+" on the account"),this.emit("ready",this.vehicles),[2,e];case 4:return n=r.sent(),this.emit("error",n),[2,n];case 5:return[2]}}))}))},t.prototype.getVehicles=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){return[2,this.controller.getVehicles()||[]]}))}))},t.prototype.getVehicle=function(e){try{var t=this.vehicles.find((function(t){return t.vin()===e||t.id()===e}));if(!t&&this.vehicles.length>0)throw new Error("Could not find vehicle with id: "+e);return t}catch(t){throw new Error("Vehicle not found: "+e+"!")}},t.prototype.refreshAccessToken=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){return[2,this.controller.refreshAccessToken()]}))}))},t.prototype.logout=function(){return l(this,void 0,void 0,(function(){return h(this,(function(e){return[2,this.controller.logout()]}))}))},t.prototype.getSession=function(){return this.controller.session},t}(s.EventEmitter);module.exports=B;
