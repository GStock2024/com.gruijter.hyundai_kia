"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var got=_interopDefault(require("got")),winston=require("winston"),url=require("url"),pr=require("push-receiver"),toughCookie=require("tough-cookie"),events=require("events"),extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function __extends(e,t){function r(){this.constructor=e}extendStatics(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var __assign=function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function __awaiter(e,i,a,c){return new(a=a||Promise)(function(r,t){function n(e){try{s(c.next(e))}catch(e){t(e)}}function o(e){try{s(c.throw(e))}catch(e){t(e)}}function s(e){var t;e.done?r(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(n,o)}s((c=c.apply(e,i||[])).next())})}function __generator(r,n){var o,s,i,e,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,s&&(i=2&t[0]?s.return:t[0]?s.throw||((i=s.return)&&i.call(s),0):s.next)&&!(i=i.call(s,t[1])).done)return i;switch(s=0,i&&(t=[2&t[0],i.value]),t[0]){case 0:case 1:i=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,s=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(i=0<(i=a.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){a.label=t[1];break}if(6===t[0]&&a.label<i[1]){a.label=i[1],i=t;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(t);break}i[2]&&a.ops.pop(),a.trys.pop();continue}t=n.call(r,a)}catch(e){t=[6,e],s=0}finally{o=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}var REGIONS,defaultLevel=process.env.LOG_LEVEL||"info",_a=winston.format,colorize=_a.colorize,json=_a.json,combine=_a.combine,timestamp=_a.timestamp,printf=_a.printf,myFormat=printf(function(e){var t=e.level,r=e.message,n=e.timestamp;return["array","object"].includes(typeof r)&&(r=JSON.stringify(r,null,2)),"["+n+"] "+t+": "+r}),combinedFormats=combine(timestamp({format:"YYYY-MM-DD HH:mm:ss"}),colorize(),json(),myFormat),logger=winston.createLogger({format:combinedFormats,level:defaultLevel,transports:[new winston.transports.Console({})]}),CLIENT_ORIGIN="SPA",CA_BASE_URL="https://mybluelink.ca",CA_ENDPOINTS={login:CA_BASE_URL+"/tods/api/lgn",logout:CA_BASE_URL+"/tods/api/lgout",myAccount:CA_BASE_URL+"/tods/api/acctinfo",nextService:CA_BASE_URL+"/tods/api/nxtsvc",preferedDealer:CA_BASE_URL+"/tods/api/gtprfrdlr",vehicleList:CA_BASE_URL+"/tods/api/vhcllst",vehicleInfo:CA_BASE_URL+"/tods/api/sltvhcl",status:CA_BASE_URL+"/tods/api/lstvhclsts",remoteStatus:CA_BASE_URL+"/tods/api/rltmvhclsts",lock:CA_BASE_URL+"/tods/api/drlck",unlock:CA_BASE_URL+"/tods/api/drulck",start:CA_BASE_URL+"/tods/api/evc/rfon",stop:CA_BASE_URL+"/tods/api/evc/rfoff",locate:CA_BASE_URL+"/tods/api/fndmcr",hornlight:CA_BASE_URL+"/tods/api/hornlight",verifyAccountToken:CA_BASE_URL+"/tods/api/vrfyacctkn",verifyPin:CA_BASE_URL+"/tods/api/vrfypin",verifyToken:CA_BASE_URL+"/tods/api/vrfytnc"},EU_BASE_URL="https://prd.eu-ccapi.hyundai.com:8080",EU_ENDPOINTS={session:EU_BASE_URL+"/api/v1/user/oauth2/authorize?response_type=code&state=test&client_id=6d477c38-3ca4-4cf3-9557-2a1929a94654&redirect_uri="+EU_BASE_URL+"/api/v1/user/oauth2/redirect",login:EU_BASE_URL+"/api/v1/user/signin",language:EU_BASE_URL+"/api/v1/user/language",redirectUri:EU_BASE_URL+"/api/v1/user/oauth2/redirect",token:EU_BASE_URL+"/api/v1/user/oauth2/token"},EU_CONSTANTS={basicToken:"Basic NmQ0NzdjMzgtM2NhNC00Y2YzLTk1NTctMmExOTI5YTk0NjU0OktVeTQ5WHhQekxwTHVvSzB4aEJDNzdXNlZYaG10UVI5aVFobUlGampvWTRJcHhzVg==",GCMSenderID:"199360397125"},ALL_ENDPOINTS={CA:CA_ENDPOINTS,EU:EU_ENDPOINTS};!function(e){e.US="US",e.CA="CA",e.EU="EU"}(REGIONS=REGIONS||{});var DEFAULT_VEHICLE_STATUS_OPTIONS={refresh:!1,parsed:!1},API_HOST="api.telematics.hyundaiusa.com",BASE_URL="https://api.telematics.hyundaiusa.com",CLIENT_ID="815c046afaa4471aa578827ad546cc76",CLIENT_SECRET="GXZveJJAVTehh/OtakM3EQ==",Vehicle=function(){function e(e,t){this.vehicleConfig=e,this.controller=t,this._status=null,this._location=null,this._odometer=null,this.userConfig={username:void 0,password:void 0,region:REGIONS.EU,autoLogin:!0,pin:void 0,vin:void 0,vehicleId:void 0},this.userConfig=t.userConfig}return e.prototype.vin=function(){return this.vehicleConfig.vin},e.prototype.name=function(){return this.vehicleConfig.name},e.prototype.nickname=function(){return this.vehicleConfig.nickname},e.prototype.id=function(){return this.vehicleConfig.id},e.prototype.brandIndicator=function(){return this.vehicleConfig.brandIndicator},e}(),AmericanVehicle=function(n){function e(e,t){var r=n.call(this,e,t)||this;return r.vehicleConfig=e,r.controller=t,r.region=REGIONS.US,logger.debug("US Vehicle "+r.vehicleConfig.id+" created"),r}return __extends(e,n),e.prototype.getDefaultHeaders=function(){return{access_token:this.controller.session.accessToken,client_id:CLIENT_ID,Host:API_HOST,"User-Agent":"okhttp/3.12.0",registrationId:this.vehicleConfig.regId,gen:this.vehicleConfig.generation,username:this.userConfig.username,vin:this.vehicleConfig.vin,"APPCLOUD-VIN":this.vehicleConfig.vin,Language:"0",to:"ISS",encryptFlag:"false",from:"SPA",brandIndicator:this.vehicleConfig.brandIndicator,bluelinkservicepin:this.userConfig.pin,offset:"-5"}},e.prototype.odometer=function(){return __awaiter(this,void 0,void 0,function(){var t,r,n,o=this;return __generator(this,function(e){switch(e.label){case 0:return[4,this._request("/ac/v2/enrollment/details/"+this.userConfig.username,{method:"GET",headers:__assign({},this.getDefaultHeaders())})];case 1:return 200!==(t=e.sent()).statusCode?[2,Promise.reject("Failed to get odometer reading!")]:(r=JSON.parse(t.body),n=r.enrolledVehicleDetails.find(function(e){return e.vehicleDetails.vin===o.vin()}),this._odometer={value:n.vehicleDetails.odometer,unit:0},[2,Promise.resolve(this._odometer)])}})})},e.prototype.location=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return[4,this._request("/ac/v2/rcs/rfc/findMyCar",{method:"GET",headers:__assign({},this.getDefaultHeaders())})];case 1:return 200!==(t=e.sent()).statusCode?[2,Promise.reject("Failed to get location!")]:(r=JSON.parse(t.body),[2,Promise.resolve({latitude:r.coord.lat,longitude:r.coord.lon,altitude:r.coord.alt,speed:{unit:r.speed.unit,value:r.speed.value},heading:r.head})])}})})},e.prototype.start=function(n){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t=__assign({airCtrl:!1,igniOnDuration:10,airTempvalue:70,defrost:!1,heating1:!1},n),r={Ims:0,airCtrl:+t.airCtrl,airTemp:{unit:1,value:""+t.airTempvalue},defrost:t.defrost,heating1:+t.heating1,igniOnDuration:t.igniOnDuration,seatHeaterVentInfo:null,username:this.userConfig.username,vin:this.vehicleConfig.vin},[4,this._request("/ac/v2/rcs/rsc/start",{method:"POST",headers:__assign(__assign({},this.getDefaultHeaders()),{offset:"-4"}),body:r,json:!0})];case 1:return 200===e.sent().statusCode?[2,Promise.resolve("Vehicle started!")]:[2,Promise.reject("Failed to start vehicle")]}})})},e.prototype.stop=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this._request(BASE_URL+"/ac/v2/rcs/rsc/stop",{method:"POST",headers:__assign(__assign({},this.getDefaultHeaders()),{offset:"-4"})})];case 1:return 200===e.sent().statusCode?[2,Promise.resolve("Vehicle stopped")]:[2,Promise.reject("Failed to stop vehicle!")]}})})},e.prototype.status=function(s){var i,a;return __awaiter(this,void 0,void 0,function(){var t,r,n,o;return __generator(this,function(e){switch(e.label){case 0:return t=__assign(__assign({},DEFAULT_VEHICLE_STATUS_OPTIONS),s),[4,this._request("/ac/v2/rcs/rvs/vehicleStatus",{method:"GET",headers:__assign({REFRESH:t.refresh.toString()},this.getDefaultHeaders())})];case 1:return r=e.sent(),n=JSON.parse(r.body).vehicleStatus,o={chassis:{hoodOpen:n.hoodOpen,trunkOpen:n.trunkOpen,locked:n.doorLock,openDoors:{frontRight:!!n.doorOpen.frontRight,frontLeft:!!n.doorOpen.frontLeft,backLeft:!!n.doorOpen.backLeft,backRight:!!n.doorOpen.backRight},tirePressureWarningLamp:{rearLeft:!!n.tirePressureLamp.tirePressureWarningLampRearLeft,frontLeft:!!n.tirePressureLamp.tirePressureWarningLampFrontLeft,frontRight:!!n.tirePressureLamp.tirePressureWarningLampFrontRight,rearRight:!!n.tirePressureLamp.tirePressureWarningLampRearRight,all:!!n.tirePressureLamp.trunkOpenStatus}},climate:{active:n.airCtrlOn,steeringwheelHeat:!!n.steerWheelHeat,sideMirrorHeat:!1,rearWindowHeat:!!n.sideBackWindowHeat,defrost:n.defrost,temperatureSetpoint:n.airTemp.value,temperatureUnit:n.airTemp.unit},engine:{ignition:n.engine,adaptiveCruiseControl:n.acc,range:n.dte.value,charging:null===(i=null==n?void 0:n.evStatus)||void 0===i?void 0:i.batteryCharge,batteryCharge:null===(a=null==n?void 0:n.battery)||void 0===a?void 0:a.batSoc}},this._status=s.parsed?o:n,[2,Promise.resolve(this._status)]}})})},e.prototype.unlock=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return(t=new url.URLSearchParams).append("userName",this.userConfig.username||""),t.append("vin",this.vehicleConfig.vin),[4,this._request("/ac/v2/rcs/rdo/on",{method:"POST",headers:__assign({},this.getDefaultHeaders()),body:t.toString()})];case 1:return 200===e.sent().statusCode?[2,Promise.resolve("Unlock successful")]:[2,Promise.reject("Something went wrong!")]}})})},e.prototype.lock=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return(t=new url.URLSearchParams).append("userName",this.userConfig.username||""),t.append("vin",this.vehicleConfig.vin),[4,this._request("/ac/v2/rcs/rdo/off",{method:"POST",headers:__assign({},this.getDefaultHeaders()),body:t.toString()})];case 1:return 200===e.sent().statusCode?[2,Promise.resolve("Lock successful")]:[2,Promise.reject("Something went wrong!")]}})})},e.prototype._request=function(n,o){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t=Math.floor(new Date/1e3),-(t-this.controller.session.tokenExpiresAt)<=60?(logger.debug("Token is expiring soon, let's get a new one"),[4,this.controller.refreshAccessToken()]):[3,2];case 1:return e.sent(),[3,3];case 2:logger.debug("Token is all good, moving on!"),e.label=3;case 3:return[4,got(BASE_URL+"/"+n,o)];case 4:return r=e.sent(),logger.debug(r.body),[2,Promise.resolve(r)]}})})},e}(Vehicle),SessionController=function(e){this.session={accessToken:"",refreshToken:"",controlToken:"",deviceId:"",tokenExpiresAt:0},this.userConfig=e},AmericanController=function(r){function e(e){var t=r.call(this,e)||this;return t.vehicles=[],logger.debug("US Controller created"),t}return __extends(e,r),e.prototype.refreshAccessToken=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t=Math.floor(new Date/1e3-this.session.tokenExpiresAt)<=10,this.session.refreshToken&&t?(logger.debug("refreshing token"),[4,got(BASE_URL+"/v2/ac/oauth/token/refresh",{method:"POST",body:{refresh_token:this.session.refreshToken},headers:{client_secret:CLIENT_SECRET,client_id:CLIENT_ID},json:!0})]):[3,2];case 1:return r=e.sent(),this.session.accessToken=r.body.access_token,this.session.refreshToken=r.body.refresh_token,this.session.tokenExpiresAt=Math.floor(new Date/1e3+parseInt(r.body.expires_in)),[2,Promise.resolve("Token refreshed")];case 2:return[2,Promise.resolve("Token not expired, no need to refresh")]}})})},e.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),logger.debug("Logging in to API"),[4,got(BASE_URL+"/v2/ac/oauth/token",{method:"POST",body:{username:this.userConfig.username,password:this.userConfig.password},headers:{client_secret:CLIENT_SECRET,client_id:CLIENT_ID},json:!0})];case 1:return t=e.sent(),this.session.accessToken=t.body.access_token,this.session.refreshToken=t.body.refresh_token,this.session.tokenExpiresAt=Math.floor(new Date/1e3+parseInt(t.body.expires_in)),[2,Promise.resolve("login good")];case 2:return r=e.sent(),logger.debug(r.body),Promise.reject(r),[3,3];case 3:return[2,Promise.reject("login bad")]}})})},e.prototype.logout=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,Promise.resolve("OK")]})})},e.prototype.getVehicles=function(){return __awaiter(this,void 0,void 0,function(){var t,r,n=this;return __generator(this,function(e){switch(e.label){case 0:return[4,got(BASE_URL+"/ac/v2/enrollment/details/"+this.userConfig.username,{method:"GET",headers:{access_token:this.session.accessToken,client_id:CLIENT_ID,Host:API_HOST,"User-Agent":"okhttp/3.12.0",payloadGenerated:"20200226171938",includeNonConnectedVehicles:"Y"}})];case 1:return t=e.sent(),void 0===(r=JSON.parse(t.body)).enrolledVehicleDetails?(this.vehicles=[],[2,Promise.resolve(this.vehicles)]):(r.enrolledVehicleDetails.forEach(function(e){var t=e.vehicleDetails,r={nickname:t.nickName,name:t.nickName,vin:t.vin,regDate:t.enrollmentDate,brandIndicator:t.brandIndicator,regId:t.regid,generation:2016<t.modelYear?"2":"1"};n.vehicles.push(new AmericanVehicle(r,n))}),[2,Promise.resolve(this.vehicles)])}})})},e}(SessionController),getTempCode=function(e){switch(e){case 14:return"00H";case 14.5:return"01H";case 15:return"02H";case 15.5:return"03H";case 16:return"04H";case 16.5:return"05H";case 17:return"06H";case 17.5:return"07H";case 18:return"08H";case 18.5:return"09H";case 19:return"0AH";case 19.5:return"0BH";case 20:return"0CH";case 20.5:return"0DH";case 21:return"0EH";case 21.5:return"0FH";case 22:return"10H";case 22.5:return"11H";case 23:return"12H";case 23.5:return"13H";case 24:return"14H";case 24.5:return"15H";case 25:return"16H";case 25.5:return"17H";case 26:return"18H";case 26.5:return"19H";case 27:return"1AH";case 27.5:return"1BH";case 28:return"1CH";case 28.5:return"1DH";case 29:return"1EH";case 29.5:return"1FH";case 30:return"20H";default:throw new Error("temperature out of bounds! min: 14.0* max: 30*, max step: 0.5")}},getTempFromCode=function(e){switch(e){case"00H":return 14;case"01H":return 14.5;case"02H":return 15;case"03H":return 15.5;case"04H":return 16;case"05H":return 16.5;case"06H":return 17;case"07H":return 17.5;case"08H":return 18;case"09H":return 18.5;case"0AH":return 19;case"0BH":return 19.5;case"0CH":return 20;case"0DH":return 20.5;case"0EH":return 21;case"0FH":return 21.5;case"10H":case"11H":return 22;case"12H":return 23;case"13H":return 23.5;case"14H":return 24;case"15H":return 24.5;case"16H":return 25;case"17H":return 25.5;case"18H":return 26;case"19H":return 26.5;case"1AH":return 27;case"1BH":return 27.5;case"1CH":return 28;case"1DH":return 28.5;case"1EH":return 29;case"1FH":return 29.5;case"20H":return 30;default:throw new Error("temperature out of bounds! min: 14.0* max: 30*, max step: 0.5")}},EuropeanVehicle=function(n){function e(e,t){var r=n.call(this,e,t)||this;return r.vehicleConfig=e,r.controller=t,r.region=REGIONS.EU,logger.debug("EU Vehicle "+r.vehicleConfig.id+" created"),r}return __extends(e,n),e.prototype.checkControlToken=function(){var t;return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return void 0===(null===(t=this.controller.session)||void 0===t?void 0:t.controlTokenExpiresAt)?[3,2]:""===this.controller.session.controlToken||(new Date).getTime()>this.controller.session.controlTokenExpiresAt?[4,this.controller.enterPin()]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})},e.prototype.start=function(r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,this.checkControlToken()];case 1:return e.sent(),[4,got(EU_BASE_URL+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/temperature",{method:"POST",body:{action:"start",hvacType:0,options:{defrost:r.defrost,heating1:r.windscreenHeating?1:0},tempCode:getTempCode(r.temperature),unit:r.unit},headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},json:!0})];case 2:return t=e.sent(),logger.info("Climate started for vehicle "+this.vehicleConfig.id),[2,Promise.resolve(t.body)]}})})},e.prototype.stop=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,this.checkControlToken()];case 1:return e.sent(),[4,got(EU_BASE_URL+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/temperature",{method:"POST",body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"},headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},json:!0})];case 2:return t=e.sent(),logger.info("Climate stopped for vehicle "+this.vehicleConfig.id),[2,Promise.resolve(t.body)]}})})},e.prototype.lock=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.checkControlToken()];case 1:return e.sent(),[4,got(EU_BASE_URL+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/door",{method:"POST",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},body:{action:"close",deviceId:this.controller.session.deviceId},json:!0})];case 2:return 200===e.sent().statusCode?(logger.debug("Vehicle "+this.vehicleConfig.id+" locked"),[2,Promise.resolve("Lock successful")]):[2,Promise.reject("Something went wrong!")]}})})},e.prototype.unlock=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.checkControlToken()];case 1:return e.sent(),[4,got(EU_BASE_URL+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/control/door",{method:"POST",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},body:{action:"open",deviceId:this.controller.session.deviceId},json:!0})];case 2:return 200===e.sent().statusCode?(logger.debug("Vehicle "+this.vehicleConfig.id+" unlocked"),[2,Promise.resolve("Unlock successful")]):[2,Promise.reject("Something went wrong!")]}})})},e.prototype.status=function(i){var a,c;return __awaiter(this,void 0,void 0,function(){var t,r,n,o,s;return __generator(this,function(e){switch(e.label){case 0:return t=__assign(__assign({},DEFAULT_VEHICLE_STATUS_OPTIONS),i),[4,this.checkControlToken()];case 1:return e.sent(),r=t.refresh?"":"/latest",[4,got(EU_BASE_URL+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/status"+r,{method:"GET",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},json:!0})];case 2:return n=e.sent(),o=t.refresh?n.body.resMsg:n.body.resMsg.vehicleStatusInfo.vehicleStatus,s={chassis:{hoodOpen:o.hoodOpen,trunkOpen:o.trunkOpen,locked:o.doorLock,openDoors:{frontRight:!!o.doorOpen.frontRight,frontLeft:!!o.doorOpen.frontLeft,backLeft:!!o.doorOpen.backLeft,backRight:!!o.doorOpen.backRight},tirePressureWarningLamp:{rearLeft:!!o.tirePressureLamp.tirePressureLampRL,frontLeft:!!o.tirePressureLamp.tirePressureLampFL,frontRight:!!o.tirePressureLamp.tirePressureLampFR,rearRight:!!o.tirePressureLamp.tirePressureLampRR,all:!!o.tirePressureLamp.tirePressureLampAll}},climate:{active:o.airCtrlOn,steeringwheelHeat:!!o.steerWheelHeat,sideMirrorHeat:!1,rearWindowHeat:!!o.sideBackWindowHeat,defrost:o.defrost,temperatureSetpoint:getTempFromCode(o.airTemp.value),temperatureUnit:o.airTemp.unit},engine:{ignition:o.engine,adaptiveCruiseControl:o.acc,range:o.evStatus.drvDistance[0].rangeByFuel.totalAvailableRange.value,charging:null===(a=null==o?void 0:o.evStatus)||void 0===a?void 0:a.batteryCharge,batteryCharge:null===(c=null==o?void 0:o.battery)||void 0===c?void 0:c.batSoc}},this._status=i.parsed?s:o,[2,Promise.resolve(this._status)]}})})},e.prototype.odometer=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,this.checkControlToken()];case 1:return e.sent(),[4,got(EU_BASE_URL+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/status/latest",{method:"GET",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},json:!0})];case 2:return t=e.sent(),this._odometer=t.body.resMsg.vehicleStatusInfo.odometer,[2,Promise.resolve(this._odometer)]}})})},e.prototype.location=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return[4,this.checkControlToken()];case 1:return e.sent(),[4,got(EU_BASE_URL+"/api/v2/spa/vehicles/"+this.vehicleConfig.id+"/location",{method:"GET",headers:{Authorization:this.controller.session.controlToken,"ccsp-device-id":this.controller.session.deviceId,"Content-Type":"application/json"},json:!0})];case 2:return t=e.sent(),r=t.body.resMsg.gpsDetail,this._location={latitude:r.coord.lat,longitude:r.coord.lon,altitude:r.coord.alt,speed:{unit:r.speed.unit,value:r.speed.value},heading:r.head},[2,Promise.resolve(this._location)]}})})},e}(Vehicle),EuropeanController=function(r){function e(e){var t=r.call(this,e)||this;return t.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:t.uuidv4(),tokenExpiresAt:0,controlTokenExpiresAt:0},t.vehicles=[],logger.debug("EU Controller created"),t.session.deviceId=t.uuidv4(),t}return __extends(e,r),e.prototype.uuidv4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},e.prototype.refreshAccessToken=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,this.login()]})})},e.prototype.enterPin=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return""===this.session.accessToken&&Promise.reject("Token not set"),[4,got(EU_BASE_URL+"/api/v1/user/pin",{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0})];case 1:return t=e.sent(),this.session.controlToken="Bearer "+t.body.controlToken,this.session.controlTokenExpiresAt=(new Date).getTime()+6e5,[2,Promise.resolve("PIN entered OK, The pin is valid for 10 minutes")]}})})},e.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){var t,r,n,o,s,i,a,c,u;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,7,,8]),t=new toughCookie.CookieJar,[4,got(ALL_ENDPOINTS.EU.session,{cookieJar:t})];case 1:return e.sent(),[4,got(ALL_ENDPOINTS.EU.language,{method:"POST",body:'{"lang":"en"}',cookieJar:t})];case 2:return e.sent(),[4,got(ALL_ENDPOINTS.EU.login,{method:"POST",json:!0,body:{email:this.userConfig.username,password:this.userConfig.password},cookieJar:t})];case 3:if(r=e.sent()){if(null===(n=/code=([^&]*)/g.exec(r.body.redirectUrl)))throw new Error("@EuropeControllerLogin: AuthCode was not found");this.session.refreshToken=n[1]}return[4,pr.register(EU_CONSTANTS.GCMSenderID)];case 4:return o=e.sent(),[4,got(EU_BASE_URL+"/api/v1/spa/notifications/register",{method:"POST",headers:{"ccsp-service-id":"6d477c38-3ca4-4cf3-9557-2a1929a94654","Content-Type":"application/json;charset=UTF-8","Content-Length":"231",Host:"prd.eu-ccapi.hyundai.com:8080",Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:{pushRegId:o.gcm.token,pushType:"GCM",uuid:this.session.deviceId},json:!0})];case 5:return(s=e.sent())&&(this.session.deviceId=s.body.resMsg.deviceId),(i=new url.URLSearchParams).append("grant_type","authorization_code"),i.append("redirect_uri",ALL_ENDPOINTS.EU.redirectUri),this.session.refreshToken&&i.append("code",this.session.refreshToken),[4,got(ALL_ENDPOINTS.EU.token,{method:"POST",headers:{Authorization:EU_CONSTANTS.basicToken,"Content-Type":"application/x-www-form-urlencoded","Content-Length":"154",Host:"prd.eu-ccapi.hyundai.com:8080",Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code"},body:i.toString(),cookieJar:t}).catch(function(e){logger.debug("Get token failed: "+e),Promise.reject("Get token failed: "+e)})];case 6:return(a=e.sent())&&(c=JSON.parse(a.body),this.session.accessToken="Bearer "+c.access_token),[2,Promise.resolve("Login success")];case 7:return u=e.sent(),logger.debug(u.body),logger.debug(u),[2,Promise.reject(u.message)];case 8:return[2]}})})},e.prototype.logout=function(){return Promise.resolve("OK")},e.prototype.getVehicles=function(){return __awaiter(this,void 0,void 0,function(){var t,r=this;return __generator(this,function(e){switch(e.label){case 0:return void 0===this.session.accessToken?[2,Promise.reject("Token not set")]:[4,got(EU_BASE_URL+"/api/v1/spa/vehicles",{method:"GET",headers:{Authorization:this.session.accessToken,"ccsp-device-id":this.session.deviceId},json:!0})];case 1:return t=e.sent(),this.vehicles=[],[4,this.asyncForEach(t.body.resMsg.vehicles,function(o){return __awaiter(r,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return[4,got(EU_BASE_URL+"/api/v1/spa/vehicles/"+o.vehicleId+"/profile",{method:"GET",headers:{Authorization:this.session.accessToken,"ccsp-device-id":this.session.deviceId},json:!0})];case 1:return t=e.sent(),r=t.body.resMsg,n={nickname:o.nickname,name:o.vehicleName,regDate:o.regDate,brandIndicator:"H",id:o.vehicleId,vin:r.vinInfo[0].basic.vin,generation:r.vinInfo[0].basic.modelYear},this.vehicles.push(new EuropeanVehicle(n,this)),logger.debug("Added vehicle "+n.id),[2]}})})})];case 2:return e.sent(),[2,Promise.resolve(this.vehicles)]}})})},e.prototype.asyncForEach=function(r,n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:t=0,e.label=1;case 1:return t<r.length?[4,n(r[t],t,r)]:[3,4];case 2:e.sent(),e.label=3;case 3:return t++,[3,1];case 4:return[2]}})})},e}(SessionController),CanadianVehicle=function(n){function e(e,t){var r=n.call(this,e,t)||this;return r.vehicleConfig=e,r.controller=t,r._nextService=null,r._info=null,r._features=null,r._featuresModel=null,r.region=REGIONS.CA,r.timeOffset=-(new Date).getTimezoneOffset()/60,logger.debug("CA Vehicle "+r.vehicleConfig.id+" created"),r}return __extends(e,n),e.prototype.vehicleInfo=function(){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:logger.debug("Begin vehicleInfo request"),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.request(CA_ENDPOINTS.vehicleInfo,{})];case 2:return t=e.sent(),r=t.result,this._info=r.vehicleInfo,this._status=r.status,this._features=r.features,this._featuresModel=r.featuresModel,[2,Promise.resolve(r)];case 3:return n=e.sent(),[2,Promise.reject("error: "+n)];case 4:return[2]}})})},e.prototype.status=function(a){var c,u;return __awaiter(this,void 0,void 0,function(){var t,r,n,o,s,i;return __generator(this,function(e){switch(e.label){case 0:t=__assign(__assign({},DEFAULT_VEHICLE_STATUS_OPTIONS),a),logger.debug("Begin status request, polling car: "+a.refresh),e.label=1;case 1:return e.trys.push([1,3,,4]),r=t.refresh?CA_ENDPOINTS.remoteStatus:CA_ENDPOINTS.status,[4,this.request(r,{})];case 2:return n=e.sent(),o=n.result,s={chassis:{hoodOpen:o.hoodOpen,trunkOpen:o.trunkOpen,locked:o.doorLock,openDoors:{frontRight:!!o.doorOpen.frontRight,frontLeft:!!o.doorOpen.frontLeft,backLeft:!!o.doorOpen.backLeft,backRight:!!o.doorOpen.backRight},tirePressureWarningLamp:{rearLeft:!!o.tirePressureLamp.tirePressureWarningLampRearLeft,frontLeft:!!o.tirePressureLamp.tirePressureWarningLampFrontLeft,frontRight:!!o.tirePressureLamp.tirePressureWarningLampFrontRight,rearRight:!!o.tirePressureLamp.tirePressureWarningLampRearRight,all:!!o.tirePressureLamp.trunkOpenStatus}},climate:{active:o.airCtrlOn,steeringwheelHeat:!!o.steerWheelHeat,sideMirrorHeat:!1,rearWindowHeat:!!o.sideBackWindowHeat,defrost:o.defrost,temperatureSetpoint:o.airTemp.value,temperatureUnit:o.airTemp.unit},engine:{ignition:o.engine,adaptiveCruiseControl:o.acc,range:o.dte.value,charging:null===(c=null==o?void 0:o.evStatus)||void 0===c?void 0:c.batteryCharge,batteryCharge:null===(u=null==o?void 0:o.battery)||void 0===u?void 0:u.batSoc}},this._status=a.parsed?s:o,[2,Promise.resolve(this._status)];case 3:return i=e.sent(),[2,Promise.reject("error: "+i)];case 4:return[2]}})})},e.prototype.nextService=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:logger.debug("Begin nextService request"),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.request(CA_ENDPOINTS.nextService,{})];case 2:return t=e.sent(),this._nextService=t.result,[2,Promise.resolve(this._nextService)];case 3:return r=e.sent(),[2,Promise.reject("error: "+r)];case 4:return[2]}})})},e.prototype.lock=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:logger.debug("Begin lock request"),e.label=1;case 1:return e.trys.push([1,4,,5]),[4,this.getPreAuth()];case 2:return t=e.sent(),[4,this.request(CA_ENDPOINTS.lock,{},{pAuth:t})];case 3:return e.sent(),[2,Promise.resolve("Lock successful")];case 4:return r=e.sent(),[2,Promise.reject("error: "+r)];case 5:return[2]}})})},e.prototype.unlock=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:logger.debug("Begin unlock request"),e.label=1;case 1:return e.trys.push([1,4,,5]),[4,this.getPreAuth()];case 2:return t=e.sent(),[4,this.request(CA_ENDPOINTS.unlock,{},{pAuth:t})];case 3:return e.sent(),[2,Promise.resolve("Unlock successful")];case 4:return r=e.sent(),[2,Promise.reject("error: "+r)];case 5:return[2]}})})},e.prototype.start=function(a){var c,u,l,h,d;return __awaiter(this,void 0,void 0,function(){var t,r,n,o,s,i;return __generator(this,function(e){switch(e.label){case 0:logger.debug("Begin startClimate request"),e.label=1;case 1:if(e.trys.push([1,4,,5]),t={hvacInfo:{airCtrl:null!==(c=a.airCtrl)&&void 0!==c&&c||null!==(u=a.defrost)&&void 0!==u&&u?1:0,defrost:null!==(l=a.defrost)&&void 0!==l&&l,heating1:a.heating1?1:0}},null!=(r=a.airTempvalue)){if(27<r||r<17)return[2,Promise.reject("air temperature should be between 17 and 27 degrees")];2==(n=(6+2*(r-17)).toString(16).toUpperCase()+"H").length&&(n="0"+n),t.hvacInfo.airTemp={value:n,unit:0,hvacTempType:1}}else if(null!==(h=a.airCtrl)&&void 0!==h&&h||null!==(d=a.defrost)&&void 0!==d&&d)return[2,Promise.reject("air temperature should be specified")];return[4,this.getPreAuth()];case 2:return o=e.sent(),[4,this.request(CA_ENDPOINTS.start,t,{pAuth:o})];case 3:return s=e.sent(),[2,Promise.resolve(s)];case 4:return i=e.sent(),[2,Promise.reject("error: "+i)];case 5:return[2]}})})},e.prototype.stop=function(){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:logger.debug("Begin stop request"),e.label=1;case 1:return e.trys.push([1,4,,5]),[4,this.getPreAuth()];case 2:return t=e.sent(),[4,this.request(CA_ENDPOINTS.stop,{pAuth:t})];case 3:return r=e.sent(),[2,Promise.resolve(r)];case 4:return n=e.sent(),[2,Promise.reject("error: "+n)];case 5:return[2]}})})},e.prototype.lights=function(o){return void 0===o&&(o=!1),__awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:logger.debug("Begin lights request with horn "+o),e.label=1;case 1:return e.trys.push([1,4,,5]),[4,this.getPreAuth()];case 2:return t=e.sent(),[4,this.request(CA_ENDPOINTS.hornlight,{horn:o},{pAuth:t})];case 3:return r=e.sent(),[2,Promise.resolve(r)];case 4:return n=e.sent(),[2,Promise.reject("error: "+n)];case 5:return[2]}})})},e.prototype.odometer=function(){throw new Error("Method not implemented.")},e.prototype.location=function(){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:logger.debug("Begin locate request"),e.label=1;case 1:return e.trys.push([1,4,,5]),[4,this.getPreAuth()];case 2:return t=e.sent(),[4,this.request(CA_ENDPOINTS.locate,{},{pAuth:t})];case 3:return r=e.sent(),this._location=r.result,[2,Promise.resolve(this._location)];case 4:return n=e.sent(),[2,Promise.reject("error: "+n)];case 5:return[2]}})})},e.prototype.getPreAuth=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:logger.info("Begin pre-authentication"),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.request(CA_ENDPOINTS.verifyPin,{})];case 2:return t=e.sent(),[2,Promise.resolve(t.result.pAuth)];case 3:return r=e.sent(),[2,Promise.reject("error: "+r)];case 4:return[2]}})})},e.prototype.request=function(n,o,s){return void 0===s&&(s={}),__awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:logger.debug("["+n+"] "+JSON.stringify(s)+" "+JSON.stringify(o)),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,got(n,{method:"POST",json:!0,headers:__assign({from:CLIENT_ORIGIN,language:1,offset:this.timeOffset,accessToken:this.controller.session.accessToken,vehicleId:this.vehicleConfig.id},s),body:__assign({pin:this.userConfig.pin},o)})];case 2:return 0!=(t=e.sent()).body.responseHeader.responseCode?[2,Promise.reject("bad request: "+t.body.responseHeader.responseDesc)]:[2,Promise.resolve(t.body)];case 3:return r=e.sent(),[2,Promise.reject("error: "+r)];case 4:return[2]}})})},e}(Vehicle),CanadianController=function(r){function e(e){var t=r.call(this,e)||this;return t._preferredDealer=null,t._accountInfo=null,t.vehicles=[],t.timeOffset=-(new Date).getTimezoneOffset()/60,logger.debug("CA Controller created"),t}return __extends(e,r),e.prototype.refreshAccessToken=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return t=Math.floor(new Date/1e3-this.session.tokenExpiresAt)<=10,this.session.refreshToken&&t?[4,this.request(CA_ENDPOINTS.verifyToken,{},{})]:[3,2];case 1:return r=e.sent(),this.session.accessToken=r.body.access_token,this.session.refreshToken=r.body.refresh_token,this.session.tokenExpiresAt=Math.floor(new Date/1e3+r.body.expires_in),[2,Promise.resolve("Token refreshed")];case 2:return[2,Promise.resolve("Token not expired, no need to refresh")]}})})},e.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:logger.info("Begin login request"),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.request(CA_ENDPOINTS.login,{loginId:this.userConfig.username,password:this.userConfig.password})];case 2:return t=e.sent(),this.session.accessToken=t.result.accessToken,this.session.refreshToken=t.result.refreshToken,this.session.tokenExpiresAt=Math.floor(new Date/1e3+t.result.expireIn),[2,Promise.resolve("login good")];case 3:return r=e.sent(),[2,Promise.reject("error: "+r)];case 4:return[2]}})})},e.prototype.logout=function(){return Promise.resolve("OK")},e.prototype.getVehicles=function(){return __awaiter(this,void 0,void 0,function(){var t,r,n,o=this;return __generator(this,function(e){switch(e.label){case 0:logger.info("Begin getVehicleList request"),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.request(CA_ENDPOINTS.vehicleList,{})];case 2:return t=e.sent(),void 0===(r=t.result).vehicles?(this.vehicles=[],[2,Promise.resolve(this.vehicles)]):(r.vehicles.forEach(function(e){var t={nickname:e.nickName,name:e.nickName,vin:e.vin,regDate:e.enrollmentDate,brandIndicator:e.brandIndicator,regId:e.regid,generation:e.genType};o.vehicles.push(new CanadianVehicle(t,o))}),[2,Promise.resolve(this.vehicles)]);case 3:return n=e.sent(),[2,Promise.reject("error: "+n)];case 4:return[2]}})})},e.prototype.myAccount=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:logger.info("Begin myAccount request"),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.request(CA_ENDPOINTS.myAccount,{})];case 2:return t=e.sent(),this._accountInfo=t.result,[2,Promise.resolve(this._accountInfo)];case 3:return r=e.sent(),[2,Promise.reject("error: "+r)];case 4:return[2]}})})},e.prototype.preferedDealer=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:logger.info("Begin preferedDealer request"),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.request(CA_ENDPOINTS.preferedDealer,{})];case 2:return t=e.sent(),this._preferredDealer=t.result,[2,Promise.resolve(this._preferredDealer)];case 3:return r=e.sent(),[2,Promise.reject("error: "+r)];case 4:return[2]}})})},e.prototype.request=function(n,o,s){return void 0===s&&(s={}),__awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:logger.debug("["+n+"] "+JSON.stringify(s)+" "+JSON.stringify(o)),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,got(n,{method:"POST",json:!0,headers:__assign({from:CLIENT_ORIGIN,language:1,offset:this.timeOffset,accessToken:this.session.accessToken},s),body:__assign({},o)})];case 2:return 0!=(t=e.sent()).body.responseHeader.responseCode?[2,Promise.reject("bad request: "+t.body.responseHeader.responseDesc)]:[2,Promise.resolve(t.body)];case 3:return r=e.sent(),logger.error(r.message),[2,Promise.reject("error: "+r)];case 4:return[2]}})})},e}(SessionController);logger.info({test:1});var BlueLinky=function(r){function e(e){var t=r.call(this)||this;switch(t.vehicles=[],t.config={username:"",password:"",region:REGIONS.US,autoLogin:!0,pin:"1234",vin:"",vehicleId:void 0},e.region){case REGIONS.EU:t.controller=new EuropeanController(e);break;case REGIONS.US:t.controller=new AmericanController(e);break;case REGIONS.CA:t.controller=new CanadianController(e);break;default:throw new Error("Your region is not supported yet.")}return t.config=__assign(__assign({},t.config),e),void 0===e.autoLogin&&(t.config.autoLogin=!0),t.onInit(),t}return __extends(e,r),e.prototype.onInit=function(){this.config.autoLogin&&(logger.debug("Bluelinky is logging in automatically, to disable use autoLogin: false"),this.login())},e.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,3,,4]),[4,this.controller.login()];case 1:return t=e.sent(),[4,(r=this).controller.getVehicles()];case 2:return r.vehicles=e.sent(),logger.debug("Found "+this.vehicles.length+" on the account"),this.emit("ready",this.vehicles),[2,t];case 3:return[2,e.sent()];case 4:return[2]}})})},e.prototype.getVehicles=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,this.controller.getVehicles()||[]]})})},e.prototype.getVehicle=function(t){try{var e=this.vehicles.find(function(e){return e.vin()===t||e.id()===t});if(!e&&0<this.vehicles.length)throw new Error("Could not find vehicle with id: "+t);return e}catch(e){throw new Error("Vehicle not found: "+t+"!")}},e.prototype.refreshAccessToken=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,this.controller.refreshAccessToken()]})})},e.prototype.logout=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,this.controller.logout()]})})},e.prototype.getSession=function(){return this.controller.session},e}(events.EventEmitter);module.exports=BlueLinky;
