/* @preserve bluelinky / MIT License / https://github.com/Hacksore/bluelinky */
"use strict";var e=require("got"),t=require("winston"),i=require("fs"),n=require("util"),o=require("push-receiver"),r=require("url"),s=require("tough-cookie"),a=require("events");function d(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function l(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(i){if("default"!==i){var n=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(t,i,n.get?n:{enumerable:!0,get:function(){return e[i]}})}})),t.default=e,Object.freeze(t)}var c=d(e),u=l(t),h=l(o),v=d(r);
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function g(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{d(n.next(e))}catch(e){r(e)}}function a(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((n=n.apply(e,t||[])).next())}))}const p=process.env.LOG_LEVEL||"info",{colorize:f,json:m,combine:y,timestamp:b,printf:w}=u.format,C=w((({level:e,message:t,timestamp:i})=>(["array","object"].includes(typeof t)&&(t=JSON.stringify(t,null,2)),`[${i}] ${e}: ${t}`))),k=y(b({format:"YYYY-MM-DD HH:mm:ss"}),f(),m(),C),S=u.createLogger({format:k,level:p,transports:[new u.transports.Console({})]}),T=e=>({login:`${e}/tods/api/lgn`,logout:`${e}/tods/api/lgout`,vehicleList:`${e}/tods/api/vhcllst`,vehicleInfo:`${e}/tods/api/sltvhcl`,status:`${e}/tods/api/lstvhclsts`,remoteStatus:`${e}/tods/api/rltmvhclsts`,lock:`${e}/tods/api/drlck`,unlock:`${e}/tods/api/drulck`,start:`${e}/tods/api/evc/rfon`,stop:`${e}/tods/api/evc/rfoff`,startCharge:`${e}/tods/api/evc/rcstrt`,stopCharge:`${e}/tods/api/evc/rcstp`,setChargeTarget:`${e}/tods/api/evc/setsoc`,locate:`${e}/tods/api/fndmcr`,hornlight:`${e}/tods/api/hornlight`,verifyAccountToken:`${e}/tods/api/vrfyacctkn`,verifyPin:`${e}/tods/api/vrfypin`,verifyToken:`${e}/tods/api/vrfytnc`}),A=e=>{const t=`https://${e}`;return{host:e,baseUrl:t,origin:"SPA",endpoints:Object.freeze(T(t))}},O=e=>{switch(e){case"hyundai":return Object.freeze(Object.assign({brand:"hyundai"},A("mybluelink.ca")));case"kia":return Object.freeze(Object.assign({brand:"hyundai"},A("kiaconnect.ca")));default:throw new Error(`Constructor ${e} is not managed.`)}};var $,E;!function(e){e[e.UNPLUGED=0]="UNPLUGED",e[e.FAST=1]="FAST",e[e.PORTABLE=2]="PORTABLE",e[e.STATION=3]="STATION"}($||($={})),function(e){e[e.FAST=0]="FAST",e[e.SLOW=1]="SLOW"}(E||(E={}));class L{constructor(e,t){this.vehicleConfig=e,this.controller=t,this._fullStatus=null,this._status=null,this._location=null,this._odometer=null,this.userConfig={username:void 0,password:void 0,region:de.EU,brand:"hyundai",autoLogin:!0,pin:void 0,vin:void 0,vehicleId:void 0},this.userConfig=t.userConfig}vin(){return this.vehicleConfig.vin}name(){return this.vehicleConfig.name}nickname(){return this.vehicleConfig.nickname}id(){return this.vehicleConfig.id}brandIndicator(){return this.vehicleConfig.brandIndicator}}const I=(e,t,i)=>{const n=[];for(let o=e;o<=t;o+=i)n.push(o);return n},D={EU:{start:14,end:30,step:.5},CA:{start:16,end:32,step:.5}},P=(e,t)=>{const{start:i,end:n,step:o}=D[e],r=I(i,n,o).indexOf(t);return`${("0x"+r.toString(16).substr(-4).toUpperCase()).split("x")[1].toUpperCase()}H`.padStart(3,"0")},x=(e,t)=>{const{start:i,end:n,step:o}=D[e];return I(i,n,o)[parseInt(t,16)]},j=e=>{const t=parseInt(e.substring(0,4)),i=parseInt(e.substring(4,6));if(e.length<=6)return new Date(t,i-1);const n=parseInt(e.substring(6,8));if(e.length<=8)return new Date(t,i-1,n);const o=parseInt(e.substring(8,10)),r=parseInt(e.substring(10,12)),s=parseInt(e.substring(12,14));return new Date(t,i-1,n,o,r,s)},R=(e,t)=>new Date(e.getTime()+6e4*t);class _ extends Error{constructor(e,t){super(e),this.source=t,this.name=_.ErrorName}}_.ErrorName="ManagedBluelinkyError";const U=(t,i)=>{var n;return t instanceof e.HTTPError?new _(`${i?`@${i}: `:""}[${t.statusCode}] ${t.statusMessage} on [${t.method}] ${t.url} - ${JSON.stringify(t.body)}`,t):t instanceof e.ParseError?new _(`${i?`@${i}: `:""} Parsing error on [${t.method}] ${t.url} - ${JSON.stringify(null===(n=t.response)||void 0===n?void 0:n.body)}`,t):(Error,t)},H=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));var M,V;!function(e){e[e.DAY=0]="DAY",e[e.MONTH=1]="MONTH",e[e.ALL=2]="ALL"}(M||(M={})),function(e){e[e.TOTAL=0]="TOTAL",e[e.AVERAGE=1]="AVERAGE",e[e.TODAY=2]="TODAY"}(V||(V={}));class N extends L{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=de.EU,this.serverRates={max:-1,current:-1},S.debug(`EU Vehicle ${this.vehicleConfig.id} created`)}start(e){return g(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/temperature`,{body:{action:"start",hvacType:0,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:P(de.EU,e.temperature),unit:e.unit}}));return S.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw U(e,"EuropeVehicle.start")}}))}stop(){return g(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/temperature`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return S.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw U(e,"EuropeVehicle.stop")}}))}lock(){return g(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(S.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw U(e,"EuropeVehicle.lock")}}))}unlock(){return g(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(S.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw U(e,"EuropeVehicle.unlock")}}))}fullStatus(e){return g(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},ce),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`)).body.resMsg.vehicleStatusInfo;if(t.refresh){const t=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`));e.vehicleStatus=t.body.resMsg;const n=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`));e.vehicleLocation=n.body.resMsg.gpsDetail}return this._fullStatus=e,this._fullStatus}catch(e){throw U(e,"EuropeVehicle.fullStatus")}}))}status(e){var t,i,n,o,r,s,a,d,l,c,u,h,v,p,f,m,y,b,w,C,k,S,T,A,O,E,L,I,D,P,R,_,H,M,V,N,B,q,F,z,J,W,Y,G;return g(this,void 0,void 0,(function*(){const g=Object.assign(Object.assign({},ce),e),K=yield this.controller.getVehicleHttpService();try{const e=g.refresh?"":"/latest",U=this.updateRates(yield K.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)),Z=g.refresh?U.body.resMsg:U.body.resMsg.vehicleStatusInfo.vehicleStatus,Q={chassis:{hoodOpen:null==Z?void 0:Z.hoodOpen,trunkOpen:null==Z?void 0:Z.trunkOpen,locked:Z.doorLock,openDoors:{frontRight:!!(null===(t=null==Z?void 0:Z.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==Z?void 0:Z.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(n=null==Z?void 0:Z.doorOpen)||void 0===n?void 0:n.backLeft),backRight:!!(null===(o=null==Z?void 0:Z.doorOpen)||void 0===o?void 0:o.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==Z?void 0:Z.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==Z?void 0:Z.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==Z?void 0:Z.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==Z?void 0:Z.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==Z?void 0:Z.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==Z?void 0:Z.airCtrlOn,steeringwheelHeat:!!(null==Z?void 0:Z.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==Z?void 0:Z.sideBackWindowHeat),defrost:null==Z?void 0:Z.defrost,temperatureSetpoint:x(de.EU,null===(c=null==Z?void 0:Z.airTemp)||void 0===c?void 0:c.value),temperatureUnit:null===(u=null==Z?void 0:Z.airTemp)||void 0===u?void 0:u.unit},engine:{ignition:Z.engine,accessory:null==Z?void 0:Z.acc,rangeGas:null!==(m=null===(f=null===(p=null===(v=null===(h=null==Z?void 0:Z.evStatus)||void 0===h?void 0:h.drvDistance[0])||void 0===v?void 0:v.rangeByFuel)||void 0===p?void 0:p.gasModeRange)||void 0===f?void 0:f.value)&&void 0!==m?m:null===(y=null==Z?void 0:Z.dte)||void 0===y?void 0:y.value,range:null===(k=null===(C=null===(w=null===(b=null==Z?void 0:Z.evStatus)||void 0===b?void 0:b.drvDistance[0])||void 0===w?void 0:w.rangeByFuel)||void 0===C?void 0:C.totalAvailableRange)||void 0===k?void 0:k.value,rangeEV:null===(O=null===(A=null===(T=null===(S=null==Z?void 0:Z.evStatus)||void 0===S?void 0:S.drvDistance[0])||void 0===T?void 0:T.rangeByFuel)||void 0===A?void 0:A.evModeRange)||void 0===O?void 0:O.value,plugedTo:null!==(L=null===(E=null==Z?void 0:Z.evStatus)||void 0===E?void 0:E.batteryPlugin)&&void 0!==L?L:$.UNPLUGED,charging:null===(I=null==Z?void 0:Z.evStatus)||void 0===I?void 0:I.batteryCharge,estimatedCurrentChargeDuration:null===(R=null===(P=null===(D=null==Z?void 0:Z.evStatus)||void 0===D?void 0:D.remainTime2)||void 0===P?void 0:P.atc)||void 0===R?void 0:R.value,estimatedFastChargeDuration:null===(M=null===(H=null===(_=null==Z?void 0:Z.evStatus)||void 0===_?void 0:_.remainTime2)||void 0===H?void 0:H.etc1)||void 0===M?void 0:M.value,estimatedPortableChargeDuration:null===(B=null===(N=null===(V=null==Z?void 0:Z.evStatus)||void 0===V?void 0:V.remainTime2)||void 0===N?void 0:N.etc2)||void 0===B?void 0:B.value,estimatedStationChargeDuration:null===(z=null===(F=null===(q=null==Z?void 0:Z.evStatus)||void 0===q?void 0:q.remainTime2)||void 0===F?void 0:F.etc3)||void 0===z?void 0:z.value,batteryCharge12v:null===(J=null==Z?void 0:Z.battery)||void 0===J?void 0:J.batSoc,batteryChargeHV:null===(W=null==Z?void 0:Z.evStatus)||void 0===W?void 0:W.batteryStatus},lastupdate:(null==Z?void 0:Z.time)?j(null==Z?void 0:Z.time):null};return Q.engine.range||(Q.engine.rangeEV||Q.engine.rangeGas)&&(Q.engine.range=(null!==(Y=Q.engine.rangeEV)&&void 0!==Y?Y:0)+(null!==(G=Q.engine.rangeGas)&&void 0!==G?G:0)),this._status=g.parsed?Q:Z,this._status}catch(e){throw U(e,"EuropeVehicle.status")}}))}odometer(){return g(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`));return this._odometer=t.body.resMsg.vehicleStatusInfo.odometer,this._odometer}catch(e){throw U(e,"EuropeVehicle.odometer")}}))}location(){var e,t,i,n,o,r,s;return g(this,void 0,void 0,(function*(){const a=yield this.controller.getVehicleHttpService();try{const d=this.updateRates(yield a.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`)),l=null!==(t=null===(e=d.body.resMsg)||void 0===e?void 0:e.gpsDetail)&&void 0!==t?t:d.body.resMsg;return this._location={latitude:null===(i=null==l?void 0:l.coord)||void 0===i?void 0:i.lat,longitude:null===(n=null==l?void 0:l.coord)||void 0===n?void 0:n.lon,altitude:null===(o=null==l?void 0:l.coord)||void 0===o?void 0:o.alt,speed:{unit:null===(r=null==l?void 0:l.speed)||void 0===r?void 0:r.unit,value:null===(s=null==l?void 0:l.speed)||void 0===s?void 0:s.value},heading:null==l?void 0:l.head},this._location}catch(e){throw U(e,"EuropeVehicle.location")}}))}startCharge(){return g(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return S.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw U(e,"EuropeVehicle.startCharge")}}))}stopCharge(){return g(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return S.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw U(e,"EuropeVehicle.stopCharge")}}))}monthlyReport(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,n,o,r,s,a,d,l,c,u;return g(this,void 0,void 0,(function*(){const h=yield this.controller.getVehicleHttpService();try{const v=this.updateRates(yield h.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:B(e)}})),g=null===(t=v.body.resMsg)||void 0===t?void 0:t.monthlyReport;return g?{start:null===(i=g.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(n=g.ifo)||void 0===n?void 0:n.mvrMonthEnd,breakdown:g.breakdown,driving:g.driving?{distance:null===(o=g.driving)||void 0===o?void 0:o.runDistance,startCount:null===(r=g.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=g.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=g.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:g.vehicleStatus?{tpms:(null===(d=g.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=g.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(u=null===(c=g.vehicleStatus)||void 0===c?void 0:c.tirePressure)||void 0===u?void 0:u.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw U(e,"EuropeVehicle.monthyReports")}}))}tripInfo(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){return g(this,void 0,void 0,(function*(){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),n=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:B(e),setTripDay:i?q(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=n.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?j(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=n.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=j(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:R(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw U(e,"EuropeVehicle.history")}}))}driveHistory(e=M.DAY){var t,i;return g(this,void 0,void 0,(function*(){const n=yield this.controller.getApiHttpService();try{const o=yield n.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=o.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=o.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?j(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw U(e,"EuropeVehicle.history")}}))}getChargeTargets(){var e;return g(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)),n=null===(e=i.body.resMsg)||void 0===e?void 0:e.targetSOClist;return n&&Array.isArray(n)?n.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw U(e,"EuropeVehicle.getChargeTargets")}}))}setChargeTargets(e){return g(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!le.includes(e.fast)||!le.includes(e.slow))throw new _(`Charge target values are limited to ${le.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:E.FAST,targetSOClevel:e.fast},{plugType:E.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw U(e,"EuropeVehicle.setChargeTargets")}}))}setNavigation(e){return g(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw U(e,"EuropeVehicle.setNavigation")}}))}updateRates(e){var t,i,n,o,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-remaining"]),(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function B(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function q(e){return e.day?`${B(e)}${e.day.toString().padStart(2,"0")}`:B(e)}class F{constructor(e){this.userConfig=e,this.session={accessToken:"",refreshToken:"",controlToken:"",deviceId:"",tokenExpiresAt:0}}}function z(e,t=re,i){return g(this,void 0,void 0,(function*(){const n=null!=i?i:new s.CookieJar;return yield c.default(e.endpoints.session,{cookieJar:n}),yield c.default(e.endpoints.language,{method:"POST",body:`{"lang":"${t}"}`,cookieJar:n}),n}))}const J={"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 11_1 like Mac OS X) AppleWebKit/604.3.5 (KHTML, like Gecko) Version/11.0 Mobile/15B92 Safari/604.1"},W=e=>e.catch((e=>"HTTPError"===e.name&&302===e.statusCode?e.response:Promise.reject(e)));class Y{constructor(e,t){this.environment=e,this.language=t}get name(){return"EuropeanBrandAuthStrategy"}login(e,t){return g(this,void 0,void 0,(function*(){const i=yield z(this.environment,this.language,null==t?void 0:t.cookieJar),{body:{userId:n,serviceId:o}}=yield c.default(this.environment.endpoints.integration,{cookieJar:i,json:!0,headers:J}),s=this.environment.brandAuthUrl({language:this.language,userId:n,serviceId:o}),a=v.default.parse(s,!0),{body:d}=yield c.default(s,{cookieJar:i,headers:J}),l=/action="([a-z0-9:/\-.?_=&;]*)"/gi.exec(d),u=null==l?void 0:l[1].replace(/&amp;/g,"&");if(!u)throw new Error("@EuropeanBrandAuthStrategy.login: cannot found the auth url from the form.");const h=new r.URLSearchParams;h.append("username",e.username),h.append("password",e.password),h.append("credentialId",""),h.append("rememberMe","on");const{headers:{location:g},body:p}=yield W(c.default.post(u,{cookieJar:i,body:h.toString(),headers:Object.assign({"Content-Type":"application/x-www-form-urlencoded"},J)}));if(!g){const e=/<span class="kc-feedback-text">(.+)<\/span>/gm.exec(p);if(e)throw new Error(`@EuropeanBrandAuthStrategy.login: Authentication failed with message : ${e[1]}`);throw new Error("@EuropeanBrandAuthStrategy.login: Authentication failed, cannot retrieve error message")}const f=yield c.default(g,{cookieJar:i,headers:J});let m=f.url,y=f.body;if(!m)throw new Error(`@EuropeanBrandAuthStrategy.login: after login redirection got stuck : ${y}`);if(m.includes("login-actions/required-action")){const e=/action="([a-z0-9:/\-.?_=&;]*)"/gi.exec(y),t=/name="code" value="(.*)"/gi.exec(y);if(!e)throw new Error("@EuropeanBrandAuthStrategy.login: Cannot find login-actions url.");if(!t)throw new Error("@EuropeanBrandAuthStrategy.login: Cannot find login-actions code.");const n=e[1].startsWith("/")?`${a.protocol}//${a.host}${e[1]}`:e[1],o=new r.URLSearchParams;o.append("code",t[1]),o.append("accept","");const{headers:{location:s},body:d}=yield W(c.default.post(n,{cookieJar:i,body:o.toString(),headers:Object.assign({"Content-Type":"application/x-www-form-urlencoded"},J)}));if(!s){const e=/<span class="kc-feedback-text">(.+)<\/span>/gm.exec(d);if(e)throw new Error(`@EuropeanBrandAuthStrategy.login: Authentication action failed with message : ${e[1]}`);throw new Error("@EuropeanBrandAuthStrategy.login: Authentication action failed, cannot retrieve error message")}const l=yield c.default(s,{cookieJar:i,headers:J});m=l.url,y=l.body}const{intUserId:b}=v.default.parse(m,!0).query;if(!b)throw S.warn("@EuropeanBrandAuthStrategy.login: Cannot find the argument userId, please use the following url and connect from a browser."),S.warn(this.environment.endpoints.session),new Error(`@EuropeanBrandAuthStrategy.login: Cannot find the argument userId in ${m}.\n\tPlease use the following url and connect from a browser, it may probably ask you to "Change your password" or "Accept the new conditions"\n\tOnce done, try again.\n\t${this.environment.endpoints.session}`);const{body:w,statusCode:C}=yield c.default.post(this.environment.endpoints.silentSignIn,{cookieJar:i,body:{intUserId:b},json:!0,headers:Object.assign(Object.assign({},J),{"ccsp-service-id":this.environment.clientId})});if(!w.redirectUrl)throw new Error(`@EuropeanBrandAuthStrategy.login: silent sign In didn't work, could not retrieve auth code. status: ${C}, body: ${JSON.stringify(w)}`);const{code:k}=v.default.parse(w.redirectUrl,!0).query;if(!k)throw new Error(`@EuropeanBrandAuthStrategy.login: Cannot find the argument code in ${w.redirectUrl}.`);return{code:k,cookies:i}}))}}class G{constructor(e,t){this.environment=e,this.language=t}get name(){return"EuropeanLegacyAuthStrategy"}login(e,t){return g(this,void 0,void 0,(function*(){const i=yield z(this.environment,this.language,null==t?void 0:t.cookieJar),{body:n,statusCode:o}=yield c.default(this.environment.endpoints.login,{method:"POST",json:!0,body:{email:e.username,password:e.password},cookieJar:i});if(!n.redirectUrl)throw new Error(`@EuropeanLegacyAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${o}, body: ${JSON.stringify(n)}`);const{code:r}=v.default.parse(n.redirectUrl,!0).query;if(!r)throw new Error("@EuropeanLegacyAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:r,cookies:i}}))}}var K;!function(e){e.LOCAL="LOCAL",e.DISTANT="DISTANT"}(K||(K={}));class Z extends F{constructor(e){var t;if(super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:H(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.userConfig.language=null!==(t=e.language)&&void 0!==t?t:re,!oe.includes(this.userConfig.language))throw new Error(`The language code ${this.userConfig.language} is not managed. Only ${oe.join(", ")} are.`);this.session.deviceId=H(),this._environment=ae(e),this.authStrategies={main:new Y(this._environment,this.userConfig.language),fallback:new G(this._environment,this.userConfig.language)},S.debug("EU Controller created")}get environment(){return this._environment}refreshAccessToken(){return g(this,void 0,void 0,(function*(){const e=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return S.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!e)return S.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const t=new r.URLSearchParams;t.append("grant_type","refresh_token"),t.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),t.append("refresh_token",this.session.refreshToken);try{const e=yield c.default(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:t.toString(),throwHttpErrors:!1});if(200!==e.statusCode)return S.debug(`Refresh token failed: ${e.body}`),`Refresh token failed: ${e.body}`;const i=JSON.parse(e.body);this.session.accessToken="Bearer "+i.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+i.expires_in)}catch(e){throw U(e,"EuropeController.refreshAccessToken")}return S.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return g(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const e=yield c.default(`${this.environment.baseUrl}/api/v1/user/pin`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+e.body.controlToken,this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+e.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw U(e,"EuropeController.pin")}}))}login(){return g(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@EuropeController.login: username and password must be defined.");let e=null;try{S.debug(`@EuropeController.login: Trying to sign in with ${this.authStrategies.main.name}`),e=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}catch(t){S.error(`@EuropeController.login: sign in with ${this.authStrategies.main.name} failed with error ${t.toString()}`),S.debug(`@EuropeController.login: Trying to sign in with ${this.authStrategies.fallback.name}`),e=yield this.authStrategies.fallback.login({password:this.userConfig.password,username:this.userConfig.username})}S.debug("@EuropeController.login: Authenticated properly with user and password");const t=yield h.register(this.environment.GCMSenderID),i=yield c.default(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:{pushRegId:t.gcm.token,pushType:"GCM",uuid:this.session.deviceId},json:!0});i&&(this.session.deviceId=i.body.resMsg.deviceId),S.debug("@EuropeController.login: Device registered");const n=new r.URLSearchParams;n.append("grant_type","authorization_code"),n.append("redirect_uri",this.environment.endpoints.redirectUri),n.append("code",e.code);const o=yield c.default(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:n.toString(),cookieJar:e.cookies});if(200!==o.statusCode)throw new Error(`@EuropeController.login: Could not manage to get token: ${o.body}`);if(o){const e=JSON.parse(o.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return S.debug("@EuropeController.login: Session defined properly"),"Login success"}catch(e){throw U(e,"EuropeController.login")}}))}logout(){return g(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return g(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const i=yield c.default(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0});this.vehicles=yield(e=i.body.resMsg.vehicles,t=e=>g(this,void 0,void 0,(function*(){const t=(yield c.default(`${this.environment.baseUrl}/api/v1/spa/vehicles/${e.vehicleId}/profile`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})).body.resMsg,i={nickname:e.nickname,name:e.vehicleName,regDate:e.regDate,brandIndicator:"H",id:e.vehicleId,vin:t.vinInfo[0].basic.vin,generation:t.vinInfo[0].basic.modelYear};return S.debug(`@EuropeController.getVehicles: Added vehicle ${i.id}`),new N(i,this)})),g(void 0,void 0,void 0,(function*(){const i=[];for(let n=0;n<e.length;n++)i.push(yield t(e[n],n,e));return i})))}catch(e){throw U(e,"EuropeController.getVehicles")}var e,t;return this.vehicles}))}checkControlToken(){var e;return g(this,void 0,void 0,(function*(){yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return g(this,void 0,void 0,(function*(){return yield this.checkControlToken(),c.default.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,Stamp:yield this.environment.stamp()}),json:!0})}))}getApiHttpService(){return g(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),c.default.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(2),"ccsp-device-id":this.session.deviceId,"ccsp-application-id":this.environment.appId,"Content-Type":"application/json"}}}const Q=Buffer.from("wLTVxwidmH8CfJYBWSnHD85blPya6TjKbuHgL2FCr+Kh8gx+uckCyT5W7h4Ngbn30xY=","base64"),X=Buffer.from("RFtoRq/vDXJmRndoZaZQyfOot7OrIqGVFj96iY2WL3yyH5Z/pUvlUhqmCxD2t+D6fP4=","base64"),ee=new Map,te=(e,t)=>()=>g(void 0,void 0,void 0,(function*(){var o;const{stamps:r,generated:s,frequency:a}=null!==(o=ee.get(e))&&void 0!==o?o:yield((e,t=`https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/${e}.v2.json`)=>g(void 0,void 0,void 0,(function*(){if(t.startsWith("file://")){const[,e]=t.split("file://"),o=yield n.promisify(i.readFile)(e);return JSON.parse(o.toString("utf-8"))}const{body:o}=yield c.default(t,{json:!0});return ee.set(e,o),o})))(e,t),d=new Date(s),l=Date.now()-d.getTime(),u=Math.floor(l/a);return u/(r.length-1)>=.9&&ee.delete(e),r[Math.min(u,r.length-1)]})),ie=(e,t)=>{const i=(e=>{switch(e){case"kia":return Q;case"hyundai":return X}})(t);return()=>g(void 0,void 0,void 0,(function*(){const t=Buffer.from(`${e}:${Date.now()}`,"utf-8");return Promise.resolve(((e,t)=>{if(e.length!==t.length)throw new Error(`XOR Buffers are not the same size ${e.length} vs ${t.length}`);const i=Buffer.alloc(e.length);for(let n=0;n<i.length;n++)i.writeUInt8(e[n]^t[n],n);return i})(i,t).toString("base64"))}))},ne=({mode:e,appId:t,brand:i,stampsFile:n})=>{switch(e){case K.LOCAL:return ie(t,i);case K.DISTANT:default:return te(`${i}-${t}`,n)}},oe=["cs","da","nl","en","fi","fr","de","it","pl","hu","no","sk","es","sv"],re="en",se=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&state=test&client_id=${t}&redirect_uri=${e}/api/v1/user/oauth2/redirect`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),ae=({brand:e,stampMode:t=K.DISTANT,stampsFile:i})=>{switch(e){case"hyundai":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="prd.eu-ccapi.hyundai.com:8080",n=`https://${i}`,o="6d477c38-3ca4-4cf3-9557-2a1929a94654",r="014d2225-8495-4735-812d-2616334fd15d";return{brand:"hyundai",host:i,baseUrl:n,clientId:o,appId:r,endpoints:Object.freeze(se(n,o)),basicToken:"Basic NmQ0NzdjMzgtM2NhNC00Y2YzLTk1NTctMmExOTI5YTk0NjU0OktVeTQ5WHhQekxwTHVvSzB4aEJDNzdXNlZYaG10UVI5aVFobUlGampvWTRJcHhzVg==",GCMSenderID:"414998006775",stamp:ne({appId:r,brand:"hyundai",mode:e,stampsFile:t}),brandAuthUrl:({language:e,serviceId:t,userId:i})=>`https://eu-account.hyundai.com/auth/realms/euhyundaiidm/protocol/openid-connect/auth?client_id=64621b96-0f0d-11ec-82a8-0242ac130003&scope=openid%20profile%20email%20phone&response_type=code&hkid_session_reset=true&redirect_uri=${n}/api/v1/user/integration/redirect/login&ui_locales=${e}&state=${t}:${i}`}})({stampMode:t,stampsFile:i}));case"kia":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="prd.eu-ccapi.kia.com:8080",n=`https://${i}`,o="fdc85c00-0a2f-4c64-bcb4-2cfb1500730a",r="e7bcd186-a5fd-410d-92cb-6876a42288bd";return{brand:"kia",host:i,baseUrl:n,clientId:o,appId:r,endpoints:Object.freeze(se(n,o)),basicToken:"Basic ZmRjODVjMDAtMGEyZi00YzY0LWJjYjQtMmNmYjE1MDA3MzBhOnNlY3JldA==",GCMSenderID:"345127537656",stamp:ne({appId:r,brand:"kia",mode:e,stampsFile:t}),brandAuthUrl:({language:e,serviceId:t,userId:i})=>`https://eu-account.kia.com/auth/realms/eukiaidm/protocol/openid-connect/auth?client_id=572e0304-5f8d-4b4c-9dd5-41aa84eed160&scope=openid%20profile%20email%20phone&response_type=code&hkid_session_reset=true&redirect_uri=${n}/api/v1/user/integration/redirect/login&ui_locales=${e}&state=${t}:${i}`}})({stampMode:t,stampsFile:i}));default:throw new Error(`Constructor ${e} is not managed.`)}};var de;!function(e){e.US="US",e.CA="CA",e.EU="EU"}(de||(de={}));const le=[50,60,70,80,90,100],ce={refresh:!1,parsed:!1};class ue extends L{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=de.US,S.debug(`US Vehicle ${this.vehicleConfig.regId} created`)}getDefaultHeaders(){return{access_token:this.controller.session.accessToken,client_id:this.controller.environment.clientId,Host:this.controller.environment.host,"User-Agent":"okhttp/3.12.0",registrationId:this.vehicleConfig.regId,gen:this.vehicleConfig.generation,username:this.userConfig.username,vin:this.vehicleConfig.vin,"APPCLOUD-VIN":this.vehicleConfig.vin,Language:"0",to:"ISS",encryptFlag:"false",from:"SPA",brandIndicator:this.vehicleConfig.brandIndicator,bluelinkservicepin:this.userConfig.pin,offset:"-5"}}fullStatus(){throw new Error("Method not implemented.")}odometer(){return g(this,void 0,void 0,(function*(){const e=yield this._request(`/ac/v2/enrollment/details/${this.userConfig.username}`,{method:"GET",headers:Object.assign({},this.getDefaultHeaders())});if(200!==e.statusCode)throw"Failed to get odometer reading!";const t=JSON.parse(e.body).enrolledVehicleDetails.find((e=>e.vehicleDetails.vin===this.vin()));return this._odometer={value:t.vehicleDetails.odometer,unit:0},this._odometer}))}location(){return g(this,void 0,void 0,(function*(){const e=yield this._request("/ac/v2/rcs/rfc/findMyCar",{method:"GET",headers:Object.assign({},this.getDefaultHeaders())});if(200!==e.statusCode)throw"Failed to get location!";const t=JSON.parse(e.body);return{latitude:t.coord.lat,longitude:t.coord.lon,altitude:t.coord.alt,speed:{unit:t.speed.unit,value:t.speed.value},heading:t.head}}))}start(e){return g(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},{hvac:!1,duration:10,temperature:70,defrost:!1,heatedFeatures:!1,unit:"F"}),e),i={Ims:0,airCtrl:+t.hvac,airTemp:{unit:1,value:`${t.temperature}`},defrost:t.defrost,heating1:+t.heatedFeatures,igniOnDuration:t.duration,seatHeaterVentInfo:null,username:this.userConfig.username,vin:this.vehicleConfig.vin};return 200===(yield this._request("/ac/v2/rcs/rsc/start",{method:"POST",headers:Object.assign(Object.assign({},this.getDefaultHeaders()),{offset:"-4"}),body:i,json:!0})).statusCode?"Vehicle started!":"Failed to start vehicle"}))}stop(){return g(this,void 0,void 0,(function*(){if(200===(yield this._request("/ac/v2/rcs/rsc/stop",{method:"POST",headers:Object.assign(Object.assign({},this.getDefaultHeaders()),{offset:"-4"})})).statusCode)return"Vehicle stopped";throw"Failed to stop vehicle!"}))}status(e){var t,i,n,o,r,s,a,d,l,c,u,h,v,p,f,m,y,b,w;return g(this,void 0,void 0,(function*(){const g=Object.assign(Object.assign({},ce),e),C=yield this._request("/ac/v2/rcs/rvs/vehicleStatus",{method:"GET",headers:Object.assign({REFRESH:g.refresh.toString()},this.getDefaultHeaders())}),{vehicleStatus:k}=JSON.parse(C.body),S={chassis:{hoodOpen:null==k?void 0:k.hoodOpen,trunkOpen:null==k?void 0:k.trunkOpen,locked:null==k?void 0:k.doorLock,openDoors:{frontRight:!!(null===(t=null==k?void 0:k.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==k?void 0:k.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(n=null==k?void 0:k.doorOpen)||void 0===n?void 0:n.backLeft),backRight:!!(null===(o=null==k?void 0:k.doorOpen)||void 0===o?void 0:o.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==k?void 0:k.tirePressureLamp)||void 0===r?void 0:r.tirePressureWarningLampRearLeft),frontLeft:!!(null===(s=null==k?void 0:k.tirePressureLamp)||void 0===s?void 0:s.tirePressureWarningLampFrontLeft),frontRight:!!(null===(a=null==k?void 0:k.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampFrontRight),rearRight:!!(null===(d=null==k?void 0:k.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampRearRight),all:!!(null===(l=null==k?void 0:k.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==k?void 0:k.airCtrlOn,steeringwheelHeat:!!(null==k?void 0:k.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==k?void 0:k.sideBackWindowHeat),defrost:null==k?void 0:k.defrost,temperatureSetpoint:null===(c=null==k?void 0:k.airTemp)||void 0===c?void 0:c.value,temperatureUnit:null===(u=null==k?void 0:k.airTemp)||void 0===u?void 0:u.unit},engine:{ignition:null==k?void 0:k.engine,accessory:null==k?void 0:k.acc,range:(null===(f=null===(p=null===(v=null===(h=null==k?void 0:k.evStatus)||void 0===h?void 0:h.drvDistance[0])||void 0===v?void 0:v.rangeByFuel)||void 0===p?void 0:p.totalAvailableRange)||void 0===f?void 0:f.value)||(null===(m=null==k?void 0:k.dte)||void 0===m?void 0:m.value),charging:null===(y=null==k?void 0:k.evStatus)||void 0===y?void 0:y.batteryCharge,batteryCharge12v:null===(b=null==k?void 0:k.battery)||void 0===b?void 0:b.batSoc,batteryChargeHV:null===(w=null==k?void 0:k.evStatus)||void 0===w?void 0:w.batteryStatus},lastupdate:new Date(null==k?void 0:k.dateTime)};return this._status=g.parsed?S:k,this._status}))}unlock(){return g(this,void 0,void 0,(function*(){const e=new r.URLSearchParams;e.append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin);return 200===(yield this._request("/ac/v2/rcs/rdo/on",{method:"POST",headers:Object.assign({},this.getDefaultHeaders()),body:e.toString()})).statusCode?"Unlock successful":"Something went wrong!"}))}lock(){return g(this,void 0,void 0,(function*(){const e=new r.URLSearchParams;e.append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin);return 200===(yield this._request("/ac/v2/rcs/rdo/off",{method:"POST",headers:Object.assign({},this.getDefaultHeaders()),body:e.toString()})).statusCode?"Lock successful":"Something went wrong!"}))}startCharge(){return g(this,void 0,void 0,(function*(){if(200===(yield this._request(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{method:"POST"})).statusCode)return S.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}))}stopCharge(){return g(this,void 0,void 0,(function*(){if(200===(yield c.default(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{method:"POST"})).statusCode)return S.debug(`Send stop charge command to vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}))}_request(e,t){return g(this,void 0,void 0,(function*(){yield this.controller.refreshAccessToken(),t.headers.access_token=this.controller.session.accessToken;const i=yield c.default(`${this.controller.environment.baseUrl}/${e}`,Object.assign({throwHttpErrors:!1},t));return(null==i?void 0:i.body)&&S.debug(i.body),i}))}}class he extends F{constructor(e){super(e),this.vehicles=[],this._environment=(e=>{if("hyundai"===e)return Object.freeze((()=>{const e="api.telematics.hyundaiusa.com";return{brand:"hyundai",host:e,baseUrl:`https://${e}`,clientId:"m66129Bb-em93-SPAHYN-bZ91-am4540zp19920",clientSecret:"v558o935-6nne-423i-baa8"}})());throw new Error(`Constructor ${e} is not managed.`)})(e.brand),S.debug("US Controller created")}get environment(){return this._environment}refreshAccessToken(){return g(this,void 0,void 0,(function*(){const e=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;try{if(this.session.refreshToken&&e){S.debug("refreshing token");const e=yield c.default(`${this.environment.baseUrl}/v2/ac/oauth/token/refresh`,{method:"POST",body:{refresh_token:this.session.refreshToken},headers:{"User-Agent":"PostmanRuntime/7.26.10",client_secret:this.environment.clientSecret,client_id:this.environment.clientId},json:!0});return S.debug(e.body),this.session.accessToken=e.body.access_token,this.session.refreshToken=e.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(e.body.expires_in)),S.debug("Token refreshed"),"Token refreshed"}return S.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh"}catch(e){throw U(e,"AmericanController.refreshAccessToken")}}))}login(){return g(this,void 0,void 0,(function*(){S.debug("Logging in to the API");try{const e=yield c.default(`${this.environment.baseUrl}/v2/ac/oauth/token`,{method:"POST",body:{username:this.userConfig.username,password:this.userConfig.password},headers:{"User-Agent":"PostmanRuntime/7.26.10",client_id:this.environment.clientId,client_secret:this.environment.clientSecret},json:!0});return S.debug(e.body),200!==e.statusCode?"login bad":(this.session.accessToken=e.body.access_token,this.session.refreshToken=e.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(e.body.expires_in)),"login good")}catch(e){throw U(e,"AmericanController.login")}}))}logout(){return g(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return g(this,void 0,void 0,(function*(){try{const e=yield c.default(`${this.environment.baseUrl}/ac/v2/enrollment/details/${this.userConfig.username}`,{method:"GET",headers:{access_token:this.session.accessToken,client_id:this.environment.clientId,Host:this.environment.host,"User-Agent":"okhttp/3.12.0",payloadGenerated:"20200226171938",includeNonConnectedVehicles:"Y"}}),t=JSON.parse(e.body);return void 0===t.enrolledVehicleDetails?(this.vehicles=[],this.vehicles):(this.vehicles=t.enrolledVehicleDetails.map((e=>{const t=e.vehicleDetails,i={nickname:t.nickName,name:t.nickName,vin:t.vin,regDate:t.enrollmentDate,brandIndicator:t.brandIndicator,regId:t.regid,generation:t.modelYear>2016?"2":"1"};return new ue(i,this)})),this.vehicles)}catch(e){throw U(e,"AmericanController.getVehicles")}}))}}class ve extends L{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=de.CA,this.timeOffset=-(new Date).getTimezoneOffset()/60,S.debug(`CA Vehicle ${this.vehicleConfig.id} created`)}fullStatus(){throw new Error("Method not implemented.")}status(e){var t,i,n,o,r,s,a,d,l,c,u,h,v,p,f,m,y;return g(this,void 0,void 0,(function*(){const g=Object.assign(Object.assign({},ce),e);S.debug("Begin status request, polling car",g.refresh);try{const e=g.refresh?this.controller.environment.endpoints.remoteStatus:this.controller.environment.endpoints.status,b=yield this.request(e,{}),w=null===(t=b.result)||void 0===t?void 0:t.status;if(null==b?void 0:b.error)throw null===(i=null==b?void 0:b.error)||void 0===i?void 0:i.errorDesc;S.debug(w);const C={chassis:{hoodOpen:null==w?void 0:w.hoodOpen,trunkOpen:null==w?void 0:w.trunkOpen,locked:null==w?void 0:w.doorLock,openDoors:{frontRight:!!(null===(n=null==w?void 0:w.doorOpen)||void 0===n?void 0:n.frontRight),frontLeft:!!(null===(o=null==w?void 0:w.doorOpen)||void 0===o?void 0:o.frontLeft),backLeft:!!(null===(r=null==w?void 0:w.doorOpen)||void 0===r?void 0:r.backLeft),backRight:!!(null===(s=null==w?void 0:w.doorOpen)||void 0===s?void 0:s.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(a=null==w?void 0:w.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampRearLeft),frontLeft:!!(null===(d=null==w?void 0:w.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampFrontLeft),frontRight:!!(null===(l=null==w?void 0:w.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampFrontRight),rearRight:!!(null===(c=null==w?void 0:w.tirePressureLamp)||void 0===c?void 0:c.tirePressureWarningLampRearRight),all:!!(null===(u=null==w?void 0:w.tirePressureLamp)||void 0===u?void 0:u.tirePressureWarningLampAll)}},climate:{active:null==w?void 0:w.airCtrlOn,steeringwheelHeat:!!(null==w?void 0:w.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==w?void 0:w.sideBackWindowHeat),defrost:null==w?void 0:w.defrost,temperatureSetpoint:null===(h=null==w?void 0:w.airTemp)||void 0===h?void 0:h.value,temperatureUnit:null===(v=null==w?void 0:w.airTemp)||void 0===v?void 0:v.unit},engine:{ignition:null==w?void 0:w.engine,accessory:null==w?void 0:w.acc,range:null===(p=null==w?void 0:w.dte)||void 0===p?void 0:p.value,charging:null===(f=null==w?void 0:w.evStatus)||void 0===f?void 0:f.batteryCharge,batteryCharge12v:null===(m=null==w?void 0:w.battery)||void 0===m?void 0:m.batSoc,batteryChargeHV:null===(y=null==w?void 0:w.evStatus)||void 0===y?void 0:y.batteryStatus},lastupdate:(null==w?void 0:w.time)?j(null==w?void 0:w.lastStatusDate):null};return this._status=g.parsed?C:w,this._status}catch(e){throw e.message}}))}lock(){return g(this,void 0,void 0,(function*(){S.debug("Begin lock request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.lock,{},{pAuth:e}),"Lock successful"}catch(e){throw e.message}}))}unlock(){return g(this,void 0,void 0,(function*(){S.debug("Begin unlock request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.unlock,{},{pAuth:e}),"Unlock successful"}catch(e){throw e.message}}))}start(e){var t,i,n,o,r;return g(this,void 0,void 0,(function*(){S.debug("Begin startClimate request");try{const s={hvacInfo:{airCtrl:null!==(t=e.hvac)&&void 0!==t&&t||null!==(i=e.defrost)&&void 0!==i&&i?1:0,defrost:null!==(n=e.defrost)&&void 0!==n&&n,heating1:e.heatedFeatures?1:0}},a=e.temperature;if(null!=a)s.hvacInfo.airTemp={value:P(de.CA,a),unit:0,hvacTempType:1};else if(null!==(o=e.hvac)&&void 0!==o&&o||null!==(r=e.defrost)&&void 0!==r&&r)throw"air temperature should be specified";const d=yield this.getPreAuth(),l=yield this.request(this.controller.environment.endpoints.start,s,{pAuth:d});return S.debug(l),l.responseHeader&&0===l.responseHeader.responseCode?"Vehicle started!":"Failed to start vehicle"}catch(e){throw e.message}}))}stop(){return g(this,void 0,void 0,(function*(){S.debug("Begin stop request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.stop,{pAuth:e})}catch(e){throw"error: "+e}}))}lights(e=!1){return g(this,void 0,void 0,(function*(){S.debug("Begin lights request with horn "+e);try{const t=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.hornlight,{horn:e},{pAuth:t})}catch(e){throw"error: "+e}}))}stopCharge(){return g(this,void 0,void 0,(function*(){S.debug("Begin stopCharge");const{stopCharge:e}=this.controller.environment.endpoints;try{const t=yield this.getPreAuth();return yield this.request(e,{pin:this.controller.userConfig.pin,pAuth:t})}catch(e){throw"error: "+e}}))}startCharge(){return g(this,void 0,void 0,(function*(){S.debug("Begin startCharge");const{startCharge:e}=this.controller.environment.endpoints;try{const t=yield this.getPreAuth();return yield this.request(e,{pin:this.controller.userConfig.pin,pAuth:t})}catch(e){throw"error: "+e}}))}setChargeTargets(e){return g(this,void 0,void 0,(function*(){if(S.debug("Begin setChargeTarget"),!le.includes(e.fast)||!le.includes(e.slow))throw new _(`Charge target values are limited to ${le.join(", ")}`);const{setChargeTarget:t}=this.controller.environment.endpoints;try{const i=yield this.getPreAuth();return yield this.request(t,{pin:this.controller.userConfig.pin,pAuth:i,tsoc:[{plugType:E.FAST,level:e.fast},{plugType:E.SLOW,level:e.slow}]})}catch(e){throw"error: "+e}}))}odometer(){throw new Error("Method not implemented.")}location(){return g(this,void 0,void 0,(function*(){S.debug("Begin locate request");try{const e=yield this.getPreAuth(),t=yield this.request(this.controller.environment.endpoints.locate,{},{pAuth:e});return this._location=t.result,this._location}catch(e){throw"error: "+e}}))}getPreAuth(){return g(this,void 0,void 0,(function*(){S.info("Begin pre-authentication");try{return(yield this.request(this.controller.environment.endpoints.verifyPin,{})).result.pAuth}catch(e){throw"error: "+e}}))}request(e,t,i={}){return g(this,void 0,void 0,(function*(){S.debug(`[${e}] ${JSON.stringify(i)} ${JSON.stringify(t)}`),yield this.controller.refreshAccessToken();const n={method:"POST",json:!0,throwHttpErrors:!1,headers:Object.assign({from:this.controller.environment.origin,language:1,offset:this.timeOffset,accessToken:this.controller.session.accessToken,vehicleId:this.vehicleConfig.id},i),body:Object.assign({pin:this.userConfig.pin},t)};try{const t=yield c.default(e,n);return 0!=t.body.responseHeader.responseCode?t.body.responseHeader.responseDesc:t.body}catch(e){throw"error: "+e}}))}}class ge extends F{constructor(e){super(e),this.vehicles=[],this.timeOffset=-(new Date).getTimezoneOffset()/60,S.debug("CA Controller created"),this._environment=O(e.brand)}get environment(){return this._environment}refreshAccessToken(){return g(this,void 0,void 0,(function*(){const e=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;return S.debug("shouldRefreshToken: "+e.toString()),this.session.refreshToken&&e?(yield this.login(),S.debug("Token refreshed"),"Token refreshed"):(S.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh")}))}login(){return g(this,void 0,void 0,(function*(){S.info("Begin login request");try{const e=yield this.request(this.environment.endpoints.login,{loginId:this.userConfig.username,password:this.userConfig.password});return S.debug(e.result),this.session.accessToken=e.result.accessToken,this.session.refreshToken=e.result.refreshToken,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+e.result.expireIn),"login good"}catch(e){return"error: "+e}}))}logout(){return g(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return g(this,void 0,void 0,(function*(){S.info("Begin getVehicleList request");try{const e=(yield this.request(this.environment.endpoints.vehicleList,{})).result;return void 0===e.vehicles?(this.vehicles=[],this.vehicles):(e.vehicles.forEach((e=>{const t={nickname:e.nickName,name:e.nickName,vin:e.vin,regDate:e.enrollmentDate,brandIndicator:e.brandIndicator,regId:e.regid,id:e.vehicleId,generation:e.genType};this.vehicles.push(new ve(t,this))})),this.vehicles)}catch(e){return S.debug(e),this.vehicles}}))}request(e,t,i={}){return g(this,void 0,void 0,(function*(){S.debug(`[${e}] ${JSON.stringify(i)} ${JSON.stringify(t)}`);try{const n=yield c.default(e,{method:"POST",json:!0,headers:Object.assign({from:this.environment.origin,language:1,offset:this.timeOffset,accessToken:this.session.accessToken},i),body:Object.assign({},t)});if(0!=n.body.responseHeader.responseCode)throw n.body.responseHeader.responseDesc;return n.body}catch(e){throw U(e,"CanadianController")}}))}}const pe={username:"",password:"",region:de.US,brand:"hyundai",autoLogin:!0,pin:"1234",vin:"",vehicleId:void 0};class fe extends a.EventEmitter{constructor(e){switch(super(),this.vehicles=[],this.config=Object.assign(Object.assign({},pe),e),e.region){case de.EU:this.controller=new Z(this.config);break;case de.US:this.controller=new he(this.config);break;case de.CA:this.controller=new ge(this.config);break;default:throw new Error("Your region is not supported yet.")}void 0===e.autoLogin&&(this.config.autoLogin=!0),this.onInit()}on(e,t){return super.on(e,t)}onInit(){this.config.autoLogin&&(S.debug("Bluelinky is logging in automatically, to disable use autoLogin: false"),this.login())}login(){return g(this,void 0,void 0,(function*(){try{const e=yield this.controller.login();return this.vehicles=yield this.getVehicles(),S.debug(`Found ${this.vehicles.length} on the account`),this.emit("ready",this.vehicles),e}catch(e){return this.emit("error",e),e.message}}))}getVehicles(){return g(this,void 0,void 0,(function*(){return(yield this.controller.getVehicles())||[]}))}getVehicle(e){try{const t=this.vehicles.find((t=>t.vin().toLowerCase()===e.toLowerCase()));if(!t&&this.vehicles.length>0)throw new Error(`Could not find vehicle with id: ${e}`);return t}catch(t){throw new Error(`Vehicle not found: ${e}!`)}}refreshAccessToken(){return g(this,void 0,void 0,(function*(){return this.controller.refreshAccessToken()}))}logout(){return g(this,void 0,void 0,(function*(){return this.controller.logout()}))}getSession(){return this.controller.session}get cachedVehicles(){var e;return null!==(e=this.vehicles)&&void 0!==e?e:[]}}module.exports=fe;
